{% extends "common/base.html" %}

{% block navbar %}
  {% include "common/partials/navbar_cliente.html" %}
  {% include "common/partials/navbar_secundario2.html" %}
{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/notificaciones.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/flash.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/catalogo.css') }}">

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category }} flash-small d-flex align-items-center" role="alert">
        {% if category == 'success' %}
          <i class="bi bi-check-circle-fill me-2"></i>
        {% elif category == 'danger' %}
          <i class="bi bi-x-circle-fill me-2"></i>
        {% elif category == 'warning' %}
          <i class="bi bi-exclamation-triangle-fill me-2"></i>
        {% elif category == 'info' %}
          <i class="bi bi-info-circle-fill me-2"></i>
        {% endif %}
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<div class="container mt-5">
  <h2 class="mb-4 text-center text-success">Catálogo de Productos</h2>
  <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-4">
    {% for producto in productos %}
    <div class="col">
      <div class="card h-100 shadow-sm position-relative">

        {% if producto.ImagenPrincipal %}
          <img src="{{ url_for('static', filename=producto.ImagenPrincipal) }}"
               class="card-img-top"
               alt="Imagen de {{ producto.NombreProducto }}">
        {% else %}
          <img src="{{ url_for('static', filename='img/catalogo.png') }}"
               class="card-img-top"
               alt="Imagen no disponible">
        {% endif %}

        <button type="button" 
                class="btn btn-light btn-favorite position-absolute top-0 end-0 m-2" 
                title="Agregar a favoritos" 
                data-id="{{ producto.ID_Producto|string }}">
          <i class="bi bi-heart"></i>
        </button>

        <div class="card-body d-flex flex-column">
          <h5 class="card-title">{{ producto.NombreProducto }}</h5>
          <p class="card-text">${{ '%.2f'|format(producto.PrecioUnidad) }}</p>

          <a href="{{ url_for('cliente.detalle_producto', id=producto.ID_Producto) }}"
             class="btn btn-outline-primary mt-auto mb-2">Ver más</a>

             

          <button type="button" class="btn btn-primary btn-add-cart mt-auto">
            <i class="bi bi-cart-plus me-2"></i> Agregar al carrito
          </button>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
function actualizarContadorFavoritos() {
  const favoritos = localStorage.getItem('favoritos');
  const favoritosArray = favoritos ? JSON.parse(favoritos) : [];
  const contador = favoritosArray.length;

  const contadorElemento = document.getElementById('contador-favoritos');
  if (contadorElemento) {
    contadorElemento.textContent = contador;
    contadorElemento.style.display = contador === 0 ? 'none' : 'inline-block';
  }
}

function toggleFavorito(id) {
  let favoritos = localStorage.getItem('favoritos');
  let favoritosArray = favoritos ? JSON.parse(favoritos) : [];

  // Convertimos el id a string para que la comparación sea consistente
  id = id.toString();

  const index = favoritosArray.indexOf(id);
  if (index === -1) {
    favoritosArray.push(id);
  } else {
    favoritosArray.splice(index, 1);
  }

  localStorage.setItem('favoritos', JSON.stringify(favoritosArray));
  actualizarContadorFavoritos();
  return index === -1; // true si fue agregado
}

function actualizarIconoFavorito(button, agregado) {
  const icon = button.querySelector('i');
  if (agregado) {
    icon.classList.remove('bi-heart');
    icon.classList.add('bi-heart-fill', 'text-danger');
  } else {
    icon.classList.add('bi-heart');
    icon.classList.remove('bi-heart-fill', 'text-danger');
  }
}

document.addEventListener('DOMContentLoaded', () => {
  actualizarContadorFavoritos();

  const favoritos = localStorage.getItem('favoritos');
  const favoritosArray = favoritos ? JSON.parse(favoritos) : [];

  const buttons = document.querySelectorAll('.btn-favorite');
  buttons.forEach(button => {
    const id = button.getAttribute('data-id').toString();
    if (favoritosArray.includes(id)) {
      actualizarIconoFavorito(button, true);
    }

    button.addEventListener('click', () => {
      const agregado = toggleFavorito(id);
      actualizarIconoFavorito(button, agregado);
    });
  });
});
</script>
{% endblock %}
