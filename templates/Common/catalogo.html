{% extends "common/base.html" %}

{% block navbar %}
{% include "common/partials/navbar_cliente.html" %}
{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/notificaciones.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/flash.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/catalogo.css') }}">

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category }} flash-small d-flex align-items-center" role="alert">
        {% if category == 'success' %}<i class="bi bi-check-circle-fill me-2"></i>
        {% elif category == 'danger' %}<i class="bi bi-x-circle-fill me-2"></i>
        {% elif category == 'warning' %}<i class="bi bi-exclamation-triangle-fill me-2"></i>
        {% elif category == 'info' %}<i class="bi bi-info-circle-fill me-2"></i>{% endif %}
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<!-- Botones flotantes -->
<a href="{{ url_for('cliente.comparar') }}" class="btn btn-warning shadow-lg position-fixed rounded-pill px-4 py-2" style="bottom: 30px; right: 100px; z-index: 1050;">
  <i class="bi bi-bar-chart me-1"></i> Comparar productos
</a>

<div class="container mt-5">
  <h2 class="mb-4 text-center text-success"><b>Catálogo de Productos</b></h2>
  <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-4">
    {% for producto in productos %}
    <div class="col">
      <div class="card h-100 shadow-sm position-relative">
        <img src="{{ url_for('static', filename=producto.ImagenPrincipal or 'img/catalogo.png') }}" class="card-img-top" alt="Imagen de {{ producto.NombreProducto }}">

        <button type="button" class="btn btn-light btn-favorite position-absolute top-0 end-0 m-2" title="Agregar a favoritos" data-id="{{ producto.ID_Producto|string }}">
          <i class="bi bi-heart"></i>
        </button>

        <div class="card-body d-flex flex-column">
          <h5 class="card-title">{{ producto.NombreProducto }}</h5>
          <p class="card-text">${{ '%.2f'|format(producto.PrecioUnidad) }}</p>

          {% if producto.Stock <= 10 and producto.Stock > 0 %}
            <p class="card-text text-danger"><b>Últimas unidades: {{ producto.Stock }}</b></p>
          {% endif %}

          <a href="{{ url_for('cliente.detalle_producto_catalogo', id=producto.ID_Producto) }}" class="btn btn-outline-primary mt-auto mb-2">Ver más</a>
          <a href="{{ url_for('cliente.escribir_resena', id=producto.ID_Producto) }}" class="btn btn-outline-warning mb-2">
            <i class="bi bi-star me-1"></i> Añadir reseña
          </a>

          <button type="button" class="btn btn-primary btn-add-cart"
            {% if producto.Stock == 0 %} disabled {% endif %}
            data-id="{{ producto.ID_Producto|string }}"
            data-nombre="{{ producto.NombreProducto }}"
            data-precio="{{ '%.2f'|format(producto.PrecioUnidad) }}"
            data-imagen="{{ url_for('static', filename=producto.ImagenPrincipal or 'img/catalogo.png') }}">
            <i class="bi bi-cart-plus me-2"></i> Agregar al carrito
          </button>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<style>
  #cart-count { font-size: 0.8rem; padding: 0.25em 0.5em; }
</style>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {

  // --- Favoritos ---
  let favoritos = JSON.parse(localStorage.getItem('favoritos') || '[]').map(String);
  const actualizarIconoFavorito = (btn, agregado) => {
    const icon = btn.querySelector('i');
    if(!icon) return;
    if(agregado){
      icon.classList.remove('bi-heart');
      icon.classList.add('bi-heart-fill','text-danger');
    } else {
      icon.classList.add('bi-heart');
      icon.classList.remove('bi-heart-fill','text-danger');
    }
  };
  document.querySelectorAll('.btn-favorite').forEach(btn=>{ actualizarIconoFavorito(btn, favoritos.includes(btn.dataset.id)); });
  document.addEventListener('click', e=>{
    const btn = e.target.closest('.btn-favorite');
    if(!btn) return;
    const id = btn.dataset.id.toString();
    const index = favoritos.indexOf(id);
    let agregado = false;
    if(index === -1){ favoritos.push(id); agregado = true; }
    else { favoritos.splice(index,1); }
    localStorage.setItem('favoritos', JSON.stringify(favoritos));
    actualizarIconoFavorito(btn, agregado);
  });

  // --- Carrito ---
  let carrito = JSON.parse(localStorage.getItem('carrito') || '[]');

  const actualizarContadorCarrito = () => {
    const contador = document.getElementById('cart-count');
    if(!contador) return;
    if(carrito.length > 0){
      contador.textContent = carrito.length;
      contador.style.display = 'inline-block';
    } else {
      contador.style.display = 'none';
    }
  };

  const mostrarMensaje = (texto,tipo) => {
    const alert = document.createElement('div');
    alert.className=`alert alert-${tipo} position-fixed top-0 end-0 m-4 shadow`;
    let iconClass = 'bi-info-circle-fill';
    if(tipo==='success') iconClass='bi-check-circle-fill';
    else if(tipo==='danger') iconClass='bi-x-circle-fill';
    else if(tipo==='warning') iconClass='bi-exclamation-triangle-fill';
    alert.innerHTML=`<i class="bi ${iconClass} me-2"></i>${texto}`;
    alert.style.zIndex=2000;
    document.body.appendChild(alert);
    setTimeout(()=>alert.remove(),3000);
  };

  const agregarAlCarrito = (btn) => {
    const id = btn.dataset.id.toString();
    // Revisar si ya existe
    let productoExistente = carrito.find(p=>p.id === id);
    if(productoExistente){
      productoExistente.cantidad += 1;
    } else {
      carrito.push({
        id: id,
        nombre: btn.dataset.nombre,
        precio: parseFloat(btn.dataset.precio),
        imagen: btn.dataset.imagen,
        cantidad: 1
      });
    }
    localStorage.setItem('carrito', JSON.stringify(carrito));
    actualizarContadorCarrito();
    mostrarMensaje("Producto agregado al carrito","success");
  };

  document.querySelectorAll('.btn-add-cart').forEach(btn=>{
    btn.addEventListener('click', ()=> agregarAlCarrito(btn));
  });

  actualizarContadorCarrito();
});
</script>
{% endblock %}
