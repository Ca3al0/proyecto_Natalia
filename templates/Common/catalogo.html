{% extends "common/base.html" %}

{% block navbar %}
{% include "common/partials/navbar_cliente.html" %}
{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/notificaciones.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/flash.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/catalogo.css') }}">

<!-- Flash messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category }} flash-small d-flex align-items-center" role="alert">
        {% if category == 'success' %}<i class="bi bi-check-circle-fill me-2"></i>
        {% elif category == 'danger' %}<i class="bi bi-x-circle-fill me-2"></i>
        {% elif category == 'warning' %}<i class="bi bi-exclamation-triangle-fill me-2"></i>
        {% elif category == 'info' %}<i class="bi bi-info-circle-fill me-2"></i>{% endif %}
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<!-- Botón flotante Comparar productos -->
<a href="{{ url_for('cliente.comparar') }}" 
   class="btn btn-warning shadow-lg position-fixed rounded-pill px-4 py-2"
   style="bottom: 30px; right: 100px; z-index: 1050;">
   <i class="bi bi-bar-chart me-1"></i> Comparar productos
</a>


<div class="container mt-5">
  <h2 class="mb-4 text-center text-success"><b>Catálogo de Productos</b></h2>
  <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-4">
    {% for producto in productos %}
    <div class="col">
      <div class="card h-100 shadow-sm position-relative">
        {% if producto.ImagenPrincipal %}
          <img src="{{ url_for('static', filename=producto.ImagenPrincipal) }}" class="card-img-top" alt="Imagen de {{ producto.NombreProducto }}">
        {% else %}
          <img src="{{ url_for('static', filename='img/catalogo.png') }}" class="card-img-top" alt="Imagen no disponible">
        {% endif %}

        <button type="button" class="btn btn-light btn-favorite position-absolute top-0 end-0 m-2" title="Agregar a favoritos" data-id="{{ producto.ID_Producto|string }}">
          <i class="bi bi-heart"></i>
        </button>

        <div class="card-body d-flex flex-column">
          <h5 class="card-title">{{ producto.NombreProducto }}</h5>
          <p class="card-text">${{ '%.2f'|format(producto.PrecioUnidad) }}</p>

          <a href="{{ url_for('cliente.detalle_producto', id=producto.ID_Producto) }}" class="btn btn-outline-primary mt-auto mb-2">Ver más</a>
          <a href="{{ url_for('cliente.escribir_resena', id=producto.ID_Producto) }}" class="btn btn-outline-warning mb-2">
            <i class="bi bi-star me-1"></i> Añadir reseña
          </a>

          <button type="button" class="btn btn-primary btn-add-cart mt-auto mb-2" data-id="{{ producto.ID_Producto|string }}">
            <i class="bi bi-cart-plus me-2"></i> Agregar al carrito
          </button>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<style>
  #cart-count {
    font-size: 0.8rem;
    padding: 0.25em 0.5em;
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // --- FAVORITOS ---
  let favoritos = JSON.parse(localStorage.getItem('favoritos') || '[]').map(String);

  const actualizarContadorFavoritos = () => {
    const contador = document.getElementById('contador-favoritos');
    contador.style.display = favoritos.length > 0 ? 'inline-block' : 'none';
    contador.textContent = favoritos.length;
  };

  const toggleFavorito = (id) => {
    id = id.toString();
    const index = favoritos.indexOf(id);
    if (index === -1) { favoritos.push(id); }
    else { favoritos.splice(index, 1); }
    localStorage.setItem('favoritos', JSON.stringify(favoritos));
    actualizarContadorFavoritos();
  };

  document.querySelectorAll('.btn-favorite').forEach(btn => {
    const id = btn.dataset.id;
    btn.addEventListener('click', () => toggleFavorito(id));
  });

  actualizarContadorFavoritos();

  // Abrir modal favoritos
  document.getElementById('btn-favoritos')?.addEventListener('click', () => {
    const container = document.getElementById('favoritosContent');
    if (favoritos.length === 0) {
      container.innerHTML = '<p>No tienes productos favoritos aún.</p>';
    } else {
      let html = '<div class="row g-3">';
      favoritos.forEach(id => {
        const card = document.querySelector(`.btn-favorite[data-id='${id}']`)?.closest('.card');
        if (card) {
          const nombre = card.querySelector('.card-title')?.textContent || '';
          const precio = card.querySelector('.card-text')?.textContent || '';
          const imgSrc = card.querySelector('img')?.getAttribute('src') || '';
          html += `
            <div class="col-6 col-md-4">
              <div class="card h-100 shadow-sm">
                <img src="${imgSrc}" class="card-img-top" alt="${nombre}">
                <div class="card-body">
                  <h6 class="card-title">${nombre}</h6>
                  <p class="card-text">${precio}</p>
                </div>
              </div>
            </div>
          `;
        }
      });
      html += '</div>';
      container.innerHTML = html;
    }
    const modal = new bootstrap.Modal(document.getElementById('favoritosModal'));
    modal.show();
  });

  // --- CARRITO ---
  let carrito = JSON.parse(localStorage.getItem('carrito') || '[]');

  const actualizarContadorCarrito = () => {
    const contador = document.getElementById('cart-count');
    if (!contador) return;
    contador.style.display = carrito.length > 0 ? 'inline-block' : 'none';
    contador.textContent = carrito.length;
  };

  const agregarAlCarrito = (id) => {
    id = id.toString();
    if (!carrito.includes(id)) {
      carrito.push(id);
      localStorage.setItem('carrito', JSON.stringify(carrito));
      actualizarContadorCarrito();
      mostrarMensaje("Producto agregado al carrito", "success");
    } else {
      mostrarMensaje("Producto ya está en el carrito", "info");
    }
  };

  const mostrarMensaje = (texto, tipo) => {
    const alert = document.createElement('div');
    alert.className = `alert alert-${tipo} position-fixed top-0 end-0 m-4 shadow`;
    alert.style.zIndex = 2000;
    alert.innerHTML = `<i class="bi bi-check-circle-fill me-2"></i>${texto}`;
    document.body.appendChild(alert);
    setTimeout(() => alert.remove(), 3000);
  };

  document.querySelectorAll('.btn-add-cart').forEach(btn => {
    btn.addEventListener('click', () => agregarAlCarrito(btn.dataset.id));
  });

  // Inicializar contador al cargar
  actualizarContadorCarrito();
});
</script>


{% endblock %}
