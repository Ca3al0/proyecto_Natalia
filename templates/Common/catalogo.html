{% extends "common/base.html" %}

{% block navbar %}
{% include "common/partials/navbar_cliente.html" %}
{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/notificaciones.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/flash.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/catalogo.css') }}">

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category }} flash-small d-flex align-items-center" role="alert">
        {% if category == 'success' %}<i class="bi bi-check-circle-fill me-2"></i>
        {% elif category == 'danger' %}<i class="bi bi-x-circle-fill me-2"></i>
        {% elif category == 'warning' %}<i class="bi bi-exclamation-triangle-fill me-2"></i>
        {% elif category == 'info' %}<i class="bi bi-info-circle-fill me-2"></i>{% endif %}
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}


<a href="{{ url_for('cliente.comparar') }}" 
   class="btn btn-warning shadow-lg position-fixed rounded-pill px-4 py-2"
   style="bottom: 30px; right: 30px; z-index: 1050;">
   <i class="bi bi-bar-chart me-1"></i> Comparar productos
</a>

<div class="container mt-5">
  <h2 class="mb-4 text-center text-success"><b>Catálogo de Productos</b></h2>
  <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-4">
    {% for producto in productos %}
    <div class="col">
      <div class="card h-100 shadow-sm position-relative">
        {% if producto.ImagenPrincipal %}
          <img src="{{ url_for('static', filename=producto.ImagenPrincipal) }}" class="card-img-top" alt="Imagen de {{ producto.NombreProducto }}">
        {% else %}
          <img src="{{ url_for('static', filename='img/catalogo.png') }}" class="card-img-top" alt="Imagen no disponible">
        {% endif %}


        <button type="button" class="btn btn-light btn-favorite position-absolute top-0 end-0 m-2" title="Agregar a favoritos" data-id="{{ producto.ID_Producto|string }}">
          <i class="bi bi-heart"></i>
        </button>

        <div class="card-body d-flex flex-column">
          <h5 class="card-title">{{ producto.NombreProducto }}</h5>
          <p class="card-text">${{ '%.2f'|format(producto.PrecioUnidad) }}</p>

          <a href="{{ url_for('cliente.detalle_producto', id=producto.ID_Producto) }}" class="btn btn-outline-primary mt-auto mb-2">Ver más</a>
          <a href="{{ url_for('cliente.escribir_resena', id=producto.ID_Producto) }}" class="btn btn-outline-warning mb-2">
            <i class="bi bi-star me-1"></i> Añadir reseña
          </a>

    
          <button type="button" class="btn btn-primary btn-add-cart mt-auto mb-2" data-id="{{ producto.ID_Producto|string }}">
            <i class="bi bi-cart-plus me-2"></i> Agregar al carrito
          </button>

        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<!-- Modal de Favoritos -->
<div class="modal fade" id="favoritosModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content position-relative rounded-4 shadow">
      
      <div class="modal-header">
        <h5 class="modal-title text-success fw-bold">Tus productos favoritos</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        {% if productos %}
          <div class="row g-4">
            {% for producto in productos %}
              <div class="col-12 col-sm-6 col-md-4">
                <div class="card h-100 shadow-sm rounded-4 overflow-hidden">
                  {% if producto.ImagenPrincipal %}
                    <img src="{{ url_for('static', filename=producto.ImagenPrincipal) }}"
                         class="card-img-top" style="object-fit: cover; height:200px;">
                  {% else %}
                    <img src="{{ url_for('static', filename='img/catalogo.png') }}"
                         class="card-img-top" style="object-fit: cover; height:200px;">
                  {% endif %}
                  <div class="card-body d-flex flex-column">
                    <h5 class="card-title">{{ producto.NombreProducto }}</h5>
                    <p class="card-text text-success fw-bold mb-3">$ {{ '%.2f' | format(producto.PrecioUnidad) }}</p>
                    <div class="mt-auto d-flex gap-2">
                      <a href="{{ url_for('cliente.detalle_producto', id=producto.ID_Producto) }}" 
                         class="btn btn-outline-primary btn-sm flex-grow-1">Ver más</a>
                      <button type="button" class="btn btn-success btn-sm flex-grow-1 btn-add-cart" data-id="{{ producto.ID_Producto|string }}">
                        <i class="bi bi-cart-plus me-1"></i> Agregar
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p class="text-muted text-center">No tienes productos favoritos.</p>
        {% endif %}
      </div>

    </div>
  </div>
</div>

<style>
  /* Asegura que el modal esté sobre el navbar */
  #favoritosModal {
    z-index: 1100; /* navbar suele ser 1050 */
  }

  /* Fondo borroso detrás del modal */
  .modal-backdrop.show {
    backdrop-filter: blur(6px);
    background-color: rgba(0, 0, 0, 0.2); /* oscurece un poco el fondo */
  }

  /* Opcional: suavizar bordes y sombra del modal */
  #favoritosModal .modal-content {
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
  }
</style>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {


  let favoritos = JSON.parse(localStorage.getItem('favoritos') || '[]').map(String);
  const actualizarContadorFavoritos = () => {
    const contador = document.getElementById('contador-favoritos');
    if(!contador) return;
    contador.textContent = favoritos.length;
    contador.style.display = favoritos.length === 0 ? 'none' : 'inline-block';
  };
  const actualizarIconoFavorito = (btn, agregado) => {
    const icon = btn.querySelector('i');
    if(!icon) return;
    if(agregado){
      icon.classList.remove('bi-heart');
      icon.classList.add('bi-heart-fill','text-danger');
    } else {
      icon.classList.add('bi-heart');
      icon.classList.remove('bi-heart-fill','text-danger');
    }
  };
  const toggleFavorito = (id) => {
    id = id.toString();
    let agregado = false;
    const index = favoritos.indexOf(id);
    if(index === -1){ favoritos.push(id); agregado=true; }
    else { favoritos.splice(index,1); }
    localStorage.setItem('favoritos', JSON.stringify(favoritos));
    actualizarContadorFavoritos();
    return agregado;
  };
  document.querySelectorAll('.btn-favorite').forEach(btn=>{
    actualizarIconoFavorito(btn, favoritos.includes(btn.dataset.id));
  });
  document.addEventListener('click', e=>{
    const btn = e.target.closest('.btn-favorite');
    if(!btn) return;
    const agregado = toggleFavorito(btn.dataset.id);
    actualizarIconoFavorito(btn, agregado);
  });
  actualizarContadorFavoritos();

  // --- Carrito ---
  let carrito = JSON.parse(localStorage.getItem('carrito') || '[]');
  const actualizarContadorCarrito = () => {
    const contador = document.getElementById('cart-count');
    if(!contador) return;
    contador.textContent = carrito.length;
    contador.style.display = carrito.length===0?'none':'inline-block';
  };
  const toggleCarrito = (id) => {
    id = id.toString();
    if(!carrito.includes(id)) carrito.push(id);
    localStorage.setItem('carrito', JSON.stringify(carrito));
    actualizarContadorCarrito();
    mostrarMensaje("Producto agregado al carrito","success");
  };
  const mostrarMensaje = (texto,tipo) => {
    const alert = document.createElement('div');
    alert.className=`alert alert-${tipo} position-fixed top-0 end-0 m-4 shadow`;
    alert.style.zIndex=2000;
    alert.innerHTML=`<i class="bi bi-check-circle-fill me-2"></i>${texto}`;
    document.body.appendChild(alert);
    setTimeout(()=>alert.remove(),3000);
  };
  document.addEventListener('click', e=>{
    const btn = e.target.closest('.btn-add-cart');
    if(!btn) return;
    toggleCarrito(btn.dataset.id);
  });
  actualizarContadorCarrito();



});
</script>
{% endblock %}