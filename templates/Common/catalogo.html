{% extends "common/base.html" %}

{% block navbar %}
{% include "common/partials/navbar_cliente.html" %}
{% include "common/partials/navbar_secundario2.html" %}
{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/notificaciones.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/flash.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/catalogo.css') }}">

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category }} flash-small d-flex align-items-center" role="alert">
        {% if category == 'success' %}<i class="bi bi-check-circle-fill me-2"></i>
        {% elif category == 'danger' %}<i class="bi bi-x-circle-fill me-2"></i>
        {% elif category == 'warning' %}<i class="bi bi-exclamation-triangle-fill me-2"></i>
        {% elif category == 'info' %}<i class="bi bi-info-circle-fill me-2"></i>{% endif %}
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<!-- Botón flotante -->
<a href="{{ url_for('cliente.comparar') }}" 
   class="btn btn-warning shadow-lg position-fixed rounded-pill px-4 py-2"
   style="bottom: 30px; right: 30px; z-index: 1050;">
   <i class="bi bi-bar-chart me-1"></i> Comparar productos
</a>


<div class="container mt-5">
  <h2 class="mb-4 text-center text-success">Catálogo de Productos</h2>
  <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-4">
    {% for producto in productos %}
    <div class="col">
      <div class="card h-100 shadow-sm position-relative">
        {% if producto.ImagenPrincipal %}
          <img src="{{ url_for('static', filename=producto.ImagenPrincipal) }}" class="card-img-top" alt="Imagen de {{ producto.NombreProducto }}">
        {% else %}
          <img src="{{ url_for('static', filename='img/catalogo.png') }}" class="card-img-top" alt="Imagen no disponible">
        {% endif %}

        <!-- Botón favorito -->
        <button type="button" class="btn btn-light btn-favorite position-absolute top-0 end-0 m-2" title="Agregar a favoritos" data-id="{{ producto.ID_Producto|string }}">
          <i class="bi bi-heart"></i>
        </button>

        <div class="card-body d-flex flex-column">
          <h5 class="card-title">{{ producto.NombreProducto }}</h5>
          <p class="card-text">${{ '%.2f'|format(producto.PrecioUnidad) }}</p>

          <a href="{{ url_for('cliente.detalle_producto', id=producto.ID_Producto) }}" class="btn btn-outline-primary mt-auto mb-2">Ver más</a>
          <a href="{{ url_for('cliente.escribir_resena', id=producto.ID_Producto) }}" class="btn btn-outline-warning mb-2">
            <i class="bi bi-star me-1"></i> Añadir reseña
          </a>

          <!-- Botón agregar al carrito -->
          <button type="button" class="btn btn-primary btn-add-cart mt-auto mb-2" data-id="{{ producto.ID_Producto|string }}">
            <i class="bi bi-cart-plus me-2"></i> Agregar al carrito
          </button>

        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>
{% endblock %}
{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {

  // --- Favoritos ---
  let favoritos = JSON.parse(localStorage.getItem('favoritos') || '[]').map(String);
  const actualizarContadorFavoritos = () => {
    const contador = document.getElementById('contador-favoritos');
    if(!contador) return;
    contador.textContent = favoritos.length;
    contador.style.display = favoritos.length === 0 ? 'none' : 'inline-block';
  };
  const actualizarIconoFavorito = (btn, agregado) => {
    const icon = btn.querySelector('i');
    if(!icon) return;
    if(agregado){
      icon.classList.remove('bi-heart');
      icon.classList.add('bi-heart-fill','text-danger');
    } else {
      icon.classList.add('bi-heart');
      icon.classList.remove('bi-heart-fill','text-danger');
    }
  };
  const toggleFavorito = (id) => {
    id = id.toString();
    let agregado = false;
    const index = favoritos.indexOf(id);
    if(index === -1){ favoritos.push(id); agregado=true; }
    else { favoritos.splice(index,1); }
    localStorage.setItem('favoritos', JSON.stringify(favoritos));
    actualizarContadorFavoritos();
    return agregado;
  };
  document.querySelectorAll('.btn-favorite').forEach(btn=>{
    actualizarIconoFavorito(btn, favoritos.includes(btn.dataset.id));
  });
  document.addEventListener('click', e=>{
    const btn = e.target.closest('.btn-favorite');
    if(!btn) return;
    const agregado = toggleFavorito(btn.dataset.id);
    actualizarIconoFavorito(btn, agregado);
  });
  actualizarContadorFavoritos();

  // --- Carrito ---
  let carrito = JSON.parse(localStorage.getItem('carrito') || '[]');
  const actualizarContadorCarrito = () => {
    const contador = document.getElementById('cart-count');
    if(!contador) return;
    contador.textContent = carrito.length;
    contador.style.display = carrito.length===0?'none':'inline-block';
  };
  const toggleCarrito = (id) => {
    id = id.toString();
    if(!carrito.includes(id)) carrito.push(id);
    localStorage.setItem('carrito', JSON.stringify(carrito));
    actualizarContadorCarrito();
    mostrarMensaje("Producto agregado al carrito","success");
  };
  const mostrarMensaje = (texto,tipo) => {
    const alert = document.createElement('div');
    alert.className=`alert alert-${tipo} position-fixed top-0 end-0 m-4 shadow`;
    alert.style.zIndex=2000;
    alert.innerHTML=`<i class="bi bi-check-circle-fill me-2"></i>${texto}`;
    document.body.appendChild(alert);
    setTimeout(()=>alert.remove(),3000);
  };
  document.addEventListener('click', e=>{
    const btn = e.target.closest('.btn-add-cart');
    if(!btn) return;
    toggleCarrito(btn.dataset.id);
  });
  actualizarContadorCarrito();



});
</script>
{% endblock %}