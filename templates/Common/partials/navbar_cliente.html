{% block navbar %}

<style>
 
#favoritosModal {
  z-index: 1100; 
}


.modal-backdrop.show {
  backdrop-filter: blur(8px);
  background-color: rgba(0,0,0,0.3);
}

</style>


<nav class="navbar navbar-expand-lg shadow-sm py-3 bg-white fixed-top">
  <div class="container position-relative d-flex justify-content-center align-items-center">

   
    <a class="navbar-brand fw-bold text-success position-absolute start-0" href="{{ url_for('index') }}">Casa en el Árbol</a>

  
    <div class="position-relative w-50">
      <input type="text" class="form-control form-control-lg rounded-pill ps-5 search-input"
             placeholder="¿Qué estás buscando hoy?">
      <i class="bi bi-search position-absolute top-50 start-0 translate-middle-y ms-3 fs-5 search-icon"></i>
    </div>


    <div class="position-absolute end-0 d-flex align-items-center gap-3">

     
      <button type="button" class="nav-icon position-relative" id="btn-favoritos" title="Ver favoritos"
              style="background:none; border:none; cursor:pointer;" aria-label="Ver favoritos">
        <i class="bi bi-heart fs-4 text-success"></i>
        <span id="contador-favoritos"
              class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
              style="display:none">0</span>
    </button>

<!-- Usuario -->
<div class="nav-item dropdown" style="position: relative;">
  <a class="nav-link dropdown-toggle fs-4 p-0" href="#" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
    <!-- Icono de usuario (opcional, puedes ocultarlo si quieres solo la bolita) -->
    <i class="bi bi-person" style="color: #57a773;"></i>
  </a>

  {% if current_user.is_authenticated %}
  <ul class="dropdown-menu shadow p-3"
      style="width: 250px; background-color: white; border-radius: 10px; top: 100%; left: auto; right: 0;">
    <li class="d-flex align-items-center mb-3">
      <!-- Bolita con iniciales -->
      <div class="rounded-circle text-white fw-bold d-flex align-items-center justify-content-center me-2"
           style="width: 45px; height: 45px; font-size: 16px; background-color: #9bd1a5;">
        {{ current_user.Nombre[0]|upper }}{{ current_user.Apellido[0]|upper }}
      </div>
      <strong class="text-uppercase">{{ current_user.Nombre }} {{ current_user.Apellido }}</strong>
    </li>
    <li><a class="dropdown-item" href="{{ url_for('cliente.actualizacion_datos') }}">Perfil</a></li>
    <li><a class="dropdown-item" href="{{ url_for('cliente.ver_notificaciones_cliente') }}">Notificaciones</a></li>
    <li class="mt-3">
      <a href="{{ url_for('auth.logout') }}" class="btn btn-success w-100">Cerrar sesión</a>
    </li>
  </ul>
  {% else %}
  <ul class="dropdown-menu shadow"
      style="width: 250px; background-color: white; border-radius: 10px; top: 100%; left: auto; right: 0;">
    <li><a class="dropdown-item" href="{{ url_for('auth.login') }}">Iniciar sesión</a></li>
    <li><a class="dropdown-item" href="{{ url_for('auth.register') }}">Registrarse</a></li>
  </ul>
  {% endif %}
</div>



      <!-- Carrito -->
      <a href="javascript:void(0)" class="nav-icon position-relative" onclick="toggleCart()" title="Ver carrito"
         aria-label="Ver carrito">
        <i class="bi bi-cart fs-4 text-success"></i>
        <span id="cart-count"
              class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">0</span>
      </a>

    </div>
  </div>
</nav>

<!-- Modal Favoritos -->
<div class="modal fade" id="favoritosModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title text-success fw-bold">Tus productos favoritos</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="favoritosContent">
        <p>Cargando...</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<style>
  /* Buscador estilo moderno */
  .search-input {
    border: 2px solid #9bd1a5 !important;
    background-color: white;
    text-align: center;
    color: #157145;
    transition: all 0.3s ease;
  }
  .search-input:focus,
  .search-input:hover {
    outline: none;
    border-color: #57a773 !important;
    box-shadow: 0 0 8px rgba(87, 167, 115, 0.5);
  }
  .search-icon {
    color: #57a773;
    pointer-events: none;
  }
</style>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  // Favoritos
  let favoritos = JSON.parse(localStorage.getItem('favoritos') || '[]').map(String);

  const actualizarContadorFavoritos = () => {
    const contador = document.getElementById('contador-favoritos');
    contador.style.display = favoritos.length > 0 ? 'inline-block' : 'none';
    contador.textContent = favoritos.length;
  };

  const actualizarIconoFavorito = (button, agregado) => {
    const icon = button.querySelector('i');
    if (!icon) return;
    if (agregado) {
      icon.classList.remove('bi-heart');
      icon.classList.add('bi-heart-fill', 'text-danger');
    } else {
      icon.classList.add('bi-heart');
      icon.classList.remove('bi-heart-fill', 'text-danger');
    }
  };

  const toggleFavorito = (id) => {
    id = id.toString();
    let agregado = false;
    const index = favoritos.indexOf(id);
    if (index === -1) { favoritos.push(id); agregado = true; }
    else { favoritos.splice(index, 1); }
    localStorage.setItem('favoritos', JSON.stringify(favoritos));
    actualizarContadorFavoritos();
    return agregado;
  };

  document.querySelectorAll('.btn-favorite').forEach(btn => {
    const id = btn.dataset.id;
    actualizarIconoFavorito(btn, favoritos.includes(id));
    btn.addEventListener('click', () => {
      const agregado = toggleFavorito(id);
      actualizarIconoFavorito(btn, agregado);
    });
  });

  actualizarContadorFavoritos();

  // Abrir modal favoritos
  document.getElementById('btn-favoritos')?.addEventListener('click', () => {
    const container = document.getElementById('favoritosContent');
    if (favoritos.length === 0) {
      container.innerHTML = '<p>No tienes productos favoritos aún.</p>';
    } else {
      let html = '<div class="row g-3">';
      favoritos.forEach(id => {
        const card = document.querySelector(`.btn-favorite[data-id='${id}']`)?.closest('.card');
        if (card) {
          const nombre = card.querySelector('.card-title')?.textContent || '';
          const precio = card.querySelector('.card-text')?.textContent || '';
          const imgSrc = card.querySelector('img')?.getAttribute('src') || '';
          html += `
            <div class="col-6 col-md-4">
              <div class="card h-100 shadow-sm">
                <img src="${imgSrc}" class="card-img-top" alt="${nombre}">
                <div class="card-body">
                  <h6 class="card-title">${nombre}</h6>
                  <p class="card-text">${precio}</p>
                </div>
              </div>
            </div>
          `;
        }
      });
      html += '</div>';
      container.innerHTML = html;
    }
    const modal = new bootstrap.Modal(document.getElementById('favoritosModal'));
    modal.show();
  });
});
</script>
{% endblock %}
