{% block navbar %}
<nav class="navbar navbar-expand-lg fixed-top bg-light shadow-sm">
  <div class="container-fluid px-4">

    <a class="navbar-brand fw-bold text-success" href="{{ url_for('index') }}">Casa en el Árbol</a>

   
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMain"
      aria-controls="navbarMain" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarMain">
      <div class="search-container mx-auto d-none d-md-block">
        <input class="form-control rounded-pill border-success-subtle" type="search"
          placeholder="¿Qué estás buscando hoy?" aria-label="Buscar">
      </div>

      <div class="d-flex align-items-center gap-3 ms-auto">

       
        <button type="button" class="nav-icon position-relative" id="btn-favoritos" title="Ver favoritos"
          style="background:none; border:none; cursor:pointer;" aria-label="Ver favoritos">
          <i class="bi bi-heart fs-4 text-success"></i>
          <span id="contador-favoritos"
            class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
            style="display:none">0</span>
        </button>

       
        <div class="dropdown">
          <a class="nav-icon dropdown-toggle" href="#" data-bs-toggle="dropdown" aria-expanded="false"
            aria-label="Menú usuario">
            <i class="bi bi-person fs-4 text-success"></i>
          </a>
          {% if current_user.is_authenticated %}
          <ul class="dropdown-menu dropdown-menu-end p-3" style="width: 250px;">
            <li class="d-flex align-items-center mb-3">
              <div class="rounded-circle bg-light border text-dark fw-bold d-flex align-items-center justify-content-center me-2"
                style="width: 45px; height: 45px; font-size: 16px;">
                {{ current_user.Nombre[0]|upper }}{{ current_user.Apellido[0]|upper }}
              </div>
              <strong class="text-uppercase">{{ current_user.Nombre }} {{ current_user.Apellido }}</strong>
            </li>
            <li><a class="dropdown-item" href="{{ url_for('cliente.actualizacion_datos') }}"> Perfil</a></li>
            <li><a class="dropdown-item" href="{{ url_for('cliente.ver_notificaciones_cliente') }}"> Notificaciones</a></li>
            <li class="mt-3">
              <a href="{{ url_for('auth.logout') }}" class="btn btn-success w-100">Cerrar sesión</a>
            </li>
          </ul>
          {% else %}
          <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item" href="{{ url_for('auth.login') }}">Iniciar sesión</a></li>
            <li><a class="dropdown-item" href="{{ url_for('auth.register') }}">Registrarse</a></li>
          </ul>
          {% endif %}
        </div>

     
        <a href="javascript:void(0)" class="nav-icon position-relative" onclick="toggleCart()" title="Ver carrito"
          aria-label="Ver carrito">
          <i class="bi bi-cart fs-4 text-success"></i>
          <span id="cart-count"
            class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">0</span>
        </a>

      </div>
    </div>
  </div>
</nav>

<div class="modal fade" id="favoritosModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title text-success fw-bold">Tus productos favoritos</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="favoritosContent">
        <p>Cargando...</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
 
  let favoritos = JSON.parse(localStorage.getItem('favoritos') || '[]').map(String);

  const actualizarContadorFavoritos = () => {
    const contador = document.getElementById('contador-favoritos');
    contador.style.display = favoritos.length > 0 ? 'inline-block' : 'none';
    contador.textContent = favoritos.length;
  };

  const actualizarIconoFavorito = (button, agregado) => {
    const icon = button.querySelector('i');
    if (!icon) return;
    if (agregado) {
      icon.classList.remove('bi-heart');
      icon.classList.add('bi-heart-fill', 'text-danger');
    } else {
      icon.classList.add('bi-heart');
      icon.classList.remove('bi-heart-fill', 'text-danger');
    }
  };

  const toggleFavorito = (id) => {
    id = id.toString();
    let agregado = false;
    const index = favoritos.indexOf(id);
    if (index === -1) { favoritos.push(id); agregado = true; }
    else { favoritos.splice(index, 1); }
    localStorage.setItem('favoritos', JSON.stringify(favoritos));
    actualizarContadorFavoritos();
    return agregado;
  };

 
  document.querySelectorAll('.btn-favorite').forEach(btn => {
    const id = btn.dataset.id;
    actualizarIconoFavorito(btn, favoritos.includes(id));
    btn.addEventListener('click', () => {
      const agregado = toggleFavorito(id);
      actualizarIconoFavorito(btn, agregado);
    });
  });

  actualizarContadorFavoritos();


  document.getElementById('btn-favoritos')?.addEventListener('click', () => {
    const container = document.getElementById('favoritosContent');
    if (favoritos.length === 0) {
      container.innerHTML = '<p>No tienes productos favoritos aún.</p>';
    } else {
      let html = '<div class="row g-3">';
      favoritos.forEach(id => {
        const card = document.querySelector(`.btn-favorite[data-id='${id}']`)?.closest('.card');
        if (card) {
          const nombre = card.querySelector('.card-title')?.textContent || '';
          const precio = card.querySelector('.card-text')?.textContent || '';
          const imgSrc = card.querySelector('img')?.getAttribute('src') || '';
          html += `
            <div class="col-6 col-md-4">
              <div class="card h-100 shadow-sm">
                <img src="${imgSrc}" class="card-img-top" alt="${nombre}">
                <div class="card-body">
                  <h6 class="card-title">${nombre}</h6>
                  <p class="card-text">${precio}</p>
                </div>
              </div>
            </div>
          `;
        }
      });
      html += '</div>';
      container.innerHTML = html;
    }
    const modal = new bootstrap.Modal(document.getElementById('favoritosModal'));
    modal.show();
  });
});
</script>
{% endblock %}
