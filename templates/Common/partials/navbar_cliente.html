{% block navbar %}

<nav class="navbar navbar-expand-lg fixed-top bg-light shadow-sm">
  <div class="container-fluid px-4">
    <!-- Logo -->
    <a class="navbar-brand fw-bold text-success" href="{{ url_for('index') }}">Casa en el √Årbol</a>

    <!-- Bot√≥n responsive -->
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMain"
      aria-controls="navbarMain" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarMain">
      <!-- Buscador -->
      <div class="search-container mx-auto d-none d-md-block">
        <input class="form-control rounded-pill border-success-subtle" type="search"
          placeholder="¬øQu√© est√°s buscando hoy?" aria-label="Buscar">
      </div>

      <!-- Iconos -->
      <div class="d-flex align-items-center gap-3 ms-auto">

        <!-- Favoritos -->
        <button type="button" class="nav-icon position-relative" id="btn-favoritos" title="Ver favoritos"
          style="background:none; border:none; cursor:pointer;" aria-label="Ver favoritos">
          <i class="bi bi-heart fs-4 text-success"></i>
          <span id="contador-favoritos"
            class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
            style="display:none">0</span>
        </button>

        <!-- Usuario -->
        <div class="dropdown">
          <a class="nav-icon dropdown-toggle" href="#" data-bs-toggle="dropdown" aria-expanded="false"
            aria-label="Men√∫ usuario">
            <i class="bi bi-person fs-4 text-success"></i>
          </a>

          {% if current_user.is_authenticated %}
          <!-- Men√∫ si el usuario est√° logueado -->
          <ul class="dropdown-menu dropdown-menu-end p-3" style="width: 250px;">
            <li class="d-flex align-items-center mb-3">
              <div class="rounded-circle bg-light border text-dark fw-bold d-flex align-items-center justify-content-center me-2"
                style="width: 45px; height: 45px; font-size: 16px;">
                {{ current_user.Nombre[0]|upper }}{{ current_user.Apellido[0]|upper }}
              </div>
              <strong class="text-uppercase">{{ current_user.Nombre }} {{ current_user.Apellido }}</strong>
            </li>

            <li><a class="dropdown-item" href="{{ url_for('cliente.actualizacion_datos') }}">üë§ Perfil</a></li>
            <li><a class="dropdown-item" href="#">üì¶ Mis pedidos</a></li>
            <li><a class="dropdown-item" href="#">‚≠ê Rese√±as</a></li>
            <li><a class="dropdown-item" href="{{ url_for('cliente.ver_notificaciones_cliente') }}">üîî Notificaciones</a></li>
            <li class="mt-3">
              <a href="{{ url_for('auth.logout') }}" class="btn btn-success w-100">Cerrar sesi√≥n</a>
            </li>
          </ul>
          {% else %}
          <!-- Men√∫ si NO est√° logueado -->
          <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item" href="{{ url_for('auth.login') }}">Iniciar sesi√≥n</a></li>
            <li><a class="dropdown-item" href="{{ url_for('auth.register') }}">Registrarse</a></li>
          </ul>
          {% endif %}
        </div>

        <!-- Carrito -->
        <a href="javascript:void(0)" class="nav-icon position-relative" onclick="toggleCart()" title="Ver carrito"
          aria-label="Ver carrito">
          <i class="bi bi-cart fs-4 text-success"></i>
          <span id="cart-count"
            class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">0</span>
        </a>

      </div>
    </div>
  </div>
</nav>

{% endblock %}

<!-- Modal Favoritos (Bootstrap puro) -->
<div class="modal fade" id="favoritosModal" tabindex="-1" aria-labelledby="favoritosModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title text-success fw-bold" id="favoritosModalLabel">Tus productos favoritos</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body" id="favoritosContent">
        <p>Cargando...</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal del Carrito (mantiene estilo personalizado) -->
<div id="modalCarrito" class="custom-modal" style="display: none;">
  <div class="custom-modal-content">
    <span class="close-button" onclick="cerrarModalCarrito()">&times;</span>
    <h4 class="mb-3">Productos en el carrito</h4>
    <div id="carritoContenido">
      <p>Cargando...</p>
    </div>
  </div>
</div>

<style>
/* Solo estilos del modal personalizado del carrito */
.custom-modal {
  position: fixed;
  z-index: 1050;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  display: none;
  background-color: rgba(0, 0, 0, 0.5);
  justify-content: center;
  align-items: center;
}

.custom-modal-content {
  background-color: #fff;
  padding: 25px 30px;
  border-radius: 12px;
  max-width: 700px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
  position: relative;
  box-shadow: 0 8px 24px rgba(0,0,0,0.3);
}
.close-button {
  position: absolute;
  top: 15px;
  right: 20px;
  font-size: 28px;
  color: #777;
  cursor: pointer;
}
.close-button:hover {
  color: #d9534f;
}
</style>

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  function obtenerFavoritos() {
    try {
      const fav = JSON.parse(localStorage.getItem('favoritos'));
      return Array.isArray(fav) ? fav : [];
    } catch {
      return [];
    }
  }

  function actualizarContadorFavoritos() {
    const favoritos = obtenerFavoritos();
    const contador = document.getElementById('contador-favoritos');
    if (favoritos.length > 0) {
      contador.style.display = 'inline-block';
      contador.textContent = favoritos.length;
    } else {
      contador.style.display = 'none';
      contador.textContent = '0';
    }
  }

  function mostrarFavoritos() {
    const favoritos = obtenerFavoritos();
    const modalEl = document.getElementById('favoritosModal');
    const modal = new bootstrap.Modal(modalEl);

    if (favoritos.length === 0) {
      document.getElementById('favoritosContent').innerHTML = '<p>No tienes productos favoritos a√∫n.</p>';
      modal.show();
      return;
    }

    fetch('/favoritos', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ ids: favoritos })
    })
    .then(res => res.ok ? res.json() : Promise.reject())
    .then(data => {
      document.getElementById('favoritosContent').innerHTML = data.html || '<p>No se encontraron productos.</p>';
      modal.show();
    })
    .catch(() => {
      document.getElementById('favoritosContent').innerHTML = '<p>Error al cargar favoritos.</p>';
      modal.show();
    });
  }

  document.getElementById('btn-favoritos')?.addEventListener('click', e => {
    e.preventDefault();
    mostrarFavoritos();
  });

  actualizarContadorFavoritos();

  window.addEventListener('storage', e => {
    if (e.key === 'favoritos') actualizarContadorFavoritos();
  });
});

// Carrito
function toggleCart() {
  const modal = document.getElementById("modalCarrito");
  modal.style.display = "flex";

  let ids = [];
  try {
    ids = JSON.parse(localStorage.getItem('carrito')) || [];
  } catch { ids = []; }

  fetch('/carrito', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ ids })
  })
  .then(res => res.json())
  .then(data => {
    document.getElementById('carritoContenido').innerHTML = data.html;
  })
  .catch(() => {
    document.getElementById('carritoContenido').innerHTML = '<p>Error al cargar carrito.</p>';
  });
}

function cerrarModalCarrito() {
  document.getElementById("modalCarrito").style.display = "none";
}

window.onclick = e => {
  const modal = document.getElementById("modalCarrito");
  if (e.target === modal) modal.style.display = "none";
};
</script>
{% endblock %}
