{% extends "common/base.html" %}

{% block navbar %}
  {% include "common/partials/navbar_admin.html" %}
{% endblock %}

{% block content %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Estadísticas de Satisfacción del Cliente</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/estadisticas.css') }}">

  <style>
    /* ======== MODAL ======== */
    .modal {
      display: none;
      position: fixed;
      z-index: 1050;
      padding-top: 100px;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.5);
      transition: all 0.3s ease;
    }

    .modal-content {
      background-color: #fff;
      margin: auto;
      padding: 30px;
      border: 2px solid #4caf50;
      border-radius: 15px;
      width: 60%;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      animation: fadeIn 0.3s ease-in-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .close-button {
      float: right;
      font-size: 24px;
      color: #4caf50;
      font-weight: bold;
      cursor: pointer;
    }

    .close-button:hover {
      color: #f44336;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    table, th, td {
      border: 1px solid #ccc;
    }

    th, td {
      padding: 8px 10px;
      text-align: center;
    }

    th {
      background-color: #4caf50;
      color: white;
    }

    /* Botones */
    .actions {
      text-align: center;
      margin-top: 40px;
    }

    .actions button {
      background-color: #4caf50;
      border: none;
      color: white;
      padding: 10px 20px;
      margin: 5px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.2s;
    }

    .actions button:hover {
      background-color: #43a047;
    }
  </style>
</head>

<body>
  <div class="todo">
    <h1>Estadísticas de Satisfacción del Cliente</h1>

    <div class="charts">
      <div class="chart-container" style="max-width: 500px; margin: 0 auto;">
        <h3 style="text-align: center;">Porcentaje de respuestas positivas</h3>
        <canvas id="pieChart" style="width: 100%; height: 500px;"></canvas>
        <p style="text-align: center;">Total respuestas: <strong id="totalRespuestas">{{ total_respuestas }}</strong></p>
      </div>
    </div>

    <div class="charts" style="margin-top: 50px;">
      <div class="chart-container">
        <h3>Comentarios negativos por producto</h3>
        <table>
          <thead>
            <tr>
              <th>Producto</th>
              <th>Comentarios Negativos</th>
            </tr>
          </thead>
          <tbody id="comentariosNegativosBody"></tbody>
        </table>
      </div>
    </div>

    <div class="actions">
      <button onclick="exportar()">Exportar resultados</button>
      <button onclick="mostrarDetalles()">Ver detalles</button>
    </div>
  </div>

  <!-- ===== MODAL ===== -->
  <div id="detalleModal" class="modal">
    <div class="modal-content">
      <span class="close-button" id="cerrarModal">&times;</span>
      <h2>Detalles de Satisfacción</h2>
      <div id="detalleContenido"></div>
    </div>
  </div>

  <script>
    const totalRespuestas = {{ total_respuestas }};
    const distribucion = {{ distribucion_json | safe }};
    const comentariosNegativos = {{ comentarios_negativos | safe }};

    // ====== Gráfico principal ======
    let positivas = 0, negativas = 0;
    for (const [calif, cant] of Object.entries(distribucion)) {
      const numCalif = parseInt(calif);
      if (numCalif >= 4) positivas += cant;
      else negativas += cant;
    }

    new Chart(document.getElementById('pieChart'), {
      type: 'doughnut',
      data: {
        labels: ['Positivas', 'Negativas'],
        datasets: [{
          data: [positivas, negativas],
          backgroundColor: ['#7cb342', '#e57373'],
          borderWidth: 1
        }]
      },
      options: {
        cutout: '70%',
        plugins: {
          legend: { position: 'bottom' }
        }
      }
    });

    // ====== Tabla comentarios negativos ======
    const tbody = document.getElementById('comentariosNegativosBody');
    tbody.innerHTML = '';
    for (const [producto, cantidad] of Object.entries(comentariosNegativos)) {
      const row = document.createElement('tr');
      row.innerHTML = `<td>${producto}</td><td>${cantidad}</td>`;
      tbody.appendChild(row);
    }

    // ====== Función Exportar PDF ======
    function exportar() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('p', 'pt', 'a4');
      let y = 40;

      doc.setFontSize(22);
      doc.setTextColor(76, 139, 55);
      doc.setFont("helvetica", "bold");
      doc.text("Estadísticas de Satisfacción del Cliente", 40, y);
      y += 30;

      doc.setDrawColor(76, 139, 55);
      doc.line(40, y, 550, y);
      y += 20;

      const pieCanvas = document.getElementById('pieChart');
      const pieDataURL = pieCanvas.toDataURL('image/png', 1.0);
      doc.addImage(pieDataURL, 'PNG', 40, y, 250, 250);
      y += 270;

      const porcentajeSatisfechos = totalRespuestas ? ((positivas / totalRespuestas) * 100).toFixed(1) : 0;
      const porcentajeInsatisfechos = totalRespuestas ? ((negativas / totalRespuestas) * 100).toFixed(1) : 0;

      doc.setFontSize(12);
      doc.setTextColor(44, 62, 80);
      doc.text(`Total de respuestas: ${totalRespuestas}`, 40, y);
      y += 20;
      doc.setTextColor(124, 179, 66);
      doc.text(`Clientes satisfechos: ${positivas} (${porcentajeSatisfechos}%)`, 40, y);
      y += 20;
      doc.setTextColor(229, 115, 115);
      doc.text(`Clientes no satisfechos: ${negativas} (${porcentajeInsatisfechos}%)`, 40, y);
      y += 30;

      doc.save("estadisticas_satisfaccion.pdf");
    }

    // ====== Modal Detalles ======
    const modal = document.getElementById("detalleModal");
    const btnCerrar = document.getElementById("cerrarModal");
    const detalleContenido = document.getElementById("detalleContenido");

    function mostrarDetalles() {
      let html = `
        <table>
          <thead>
            <tr>
              <th>Calificación</th>
              <th>Cantidad de respuestas</th>
              <th>Porcentaje</th>
            </tr>
          </thead>
          <tbody>
      `;

      for (const [calif, cantidad] of Object.entries(distribucion)) {
        const porcentaje = totalRespuestas ? ((cantidad / totalRespuestas) * 100).toFixed(1) : 0;
        html += `<tr><td>${calif}</td><td>${cantidad}</td><td>${porcentaje}%</td></tr>`;
      }

      html += `
          </tbody>
        </table>
        <h4 style="margin-top:20px;">Resumen</h4>
        <p><strong>Total respuestas:</strong> ${totalRespuestas}</p>
        <p><strong>Positivas:</strong> ${positivas}</p>
        <p><strong>Negativas:</strong> ${negativas}</p>
      `;

      detalleContenido.innerHTML = html;
      modal.style.display = "block";
    }

    // Cerrar modal
    btnCerrar.onclick = () => modal.style.display = "none";
    window.onclick = (e) => { if (e.target === modal) modal.style.display = "none"; };
  </script>
</body>
</html>
{% endblock %}
