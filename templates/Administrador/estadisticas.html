{% extends "common/base.html" %}

{% block navbar %}
  {% include "common/partials/navbar_admin.html" %}
{% endblock %}

{% block content %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Estadísticas de Satisfacción del Cliente</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Al inicio del body o en head -->
   <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <link rel="stylesheet" href="{{ url_for('static', filename='css/estadisticas.css') }}">
</head>
<body>

<div class="todo">
    <h1>Estadísticas de Satisfacción del Cliente</h1>

<div class="charts">
    <div class="chart-container" style="max-width: 500px; margin: 0 auto;">
        <h3 style="text-align: center;">Porcentaje de respuestas positivas</h3>
        <canvas id="pieChart" style="width: 100%; height: 500px;"></canvas>
        <p style="text-align: center;">Total respuestas: <strong id="totalRespuestas">{{ total_respuestas }}</strong></p>
    </div>
</div>



    <div class="charts" style="margin-top: 50px;">
        <div class="chart-container">
            <h3>Comentarios negativos por producto</h3>
            <table>
                <thead>
                    <tr>
                        <th>Producto</th>
                        <th>Comentarios Negativos</th>
                    </tr>
                </thead>
                <tbody id="comentariosNegativosBody"></tbody>
            </table>
        </div>
    </div>

    <div class="actions">
        <button onclick="exportar()">Exportar resultados</button>
        <button onclick="mostrarDetalles()">Ver detalles</button>
    </div>
</div>

<div id="detalleModal" class="modal">
  <div class="modal-content">
    <span class="close-button">&times;</span>
    <h2>Detalles de Satisfacción</h2>
    <div id="detalleContenido"></div>
  </div>
</div>

<script>
    const totalRespuestas = {{ total_respuestas }};
    const distribucion = {{ distribucion_json | safe }};
    const comentariosNegativos = {{ comentarios_negativos | safe }};

    let positivas = 0;
    let negativas = 0;
    for (const [calif, cant] of Object.entries(distribucion)) {
        const numCalif = parseInt(calif);
        if (numCalif >= 4) {
            positivas += cant;
        } else {
            negativas += cant;
        }
    }

    new Chart(document.getElementById('pieChart'), {
        type: 'doughnut',
        data: {
            labels: ['Positivas', 'Negativas'],
            datasets: [{
                data: [positivas, negativas],
                backgroundColor: ['#7cb342', '#e57373'],
                borderWidth: 1
            }]
        },
        options: {
            cutout: '70%',
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });

    const tbody = document.getElementById('comentariosNegativosBody');
    tbody.innerHTML = '';
    for (const [producto, cantidad] of Object.entries(comentariosNegativos)) {
        const row = document.createElement('tr');
        row.innerHTML = `<td>${producto}</td><td>${cantidad}</td>`;
        tbody.appendChild(row);
    }

  function exportar() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'pt', 'a4');
    let y = 40;

    // Título
    doc.setFontSize(22);
    doc.setTextColor(76, 139, 55); // Verde principal (#4c8b37 parecido a tu tema)
    doc.setFont("helvetica", "bold");
    doc.text("Estadísticas de Satisfacción del Cliente", 40, y);
    y += 30;

    // Línea separadora
    doc.setDrawColor(76, 139, 55);
    doc.setLineWidth(1.5);
    doc.line(40, y, 550, y);
    y += 20;

    // Gráfico de respuestas positivas
    const pieCanvas = document.getElementById('pieChart');
    const pieDataURL = pieCanvas.toDataURL('image/png', 1.0);
    doc.addImage(pieDataURL, 'PNG', 40, y, 250, 250);
    y += 270;

    // Resumen de respuestas con estilo
    const total = totalRespuestas;
    const satisfechos = positivas;
    const insatisfechos = negativas;
    const porcentajeSatisfechos = total ? ((satisfechos / total) * 100).toFixed(1) : 0;
    const porcentajeInsatisfechos = total ? ((insatisfechos / total) * 100).toFixed(1) : 0;

    doc.setFontSize(12);
    doc.setTextColor(44, 62, 80); // texto oscuro
    doc.setFont("helvetica", "normal");
    doc.text(`Total de respuestas: ${total}`, 40, y);
    y += 20;
    doc.setTextColor(124, 179, 66); // verde positivo
    doc.text(`Clientes satisfechos: ${satisfechos} (${porcentajeSatisfechos}%)`, 40, y);
    y += 20;
    doc.setTextColor(229, 115, 115); // rojo negativo
    doc.text(`Clientes no satisfechos: ${insatisfechos} (${porcentajeInsatisfechos}%)`, 40, y);
    y += 30;

    // Comentarios negativos con estilo de tabla
    doc.setTextColor(44, 62, 80);
    doc.setFont("helvetica", "bold");
    doc.text("Comentarios negativos por producto:", 40, y);
    y += 20;
    doc.setFont("helvetica", "normal");

    for (const [producto, cantidad] of Object.entries(comentariosNegativos)) {
        doc.setFillColor(244, 244, 244); // fondo gris claro
        doc.rect(40, y - 12, 500, 18, 'F'); // rectángulo de fondo
        doc.setTextColor(44, 62, 80);
        doc.text(`${producto}: ${cantidad}`, 45, y);
        y += 22;
        if (y > 750) {
            doc.addPage();
            y = 40;
        }
    }

    // Guardar PDF
    doc.save("estadisticas_satisfaccion.pdf");
}




</script>
</body>
</html>
{% endblock %}
