{% extends "common/base.html" %}

{% block title %}Gesti√≥n de Proveedores y Compras{% endblock %}

{% block content %}
<div class="container mt-5 p-4 bg-white rounded shadow">

    <h3 class="text-center text-success mb-4">Gesti√≥n de Proveedores y Compras</h3>

    <div id="alerta" class="alert text-center" style="display:none;"></div>

    <div class="row">
        <!-- PANEL PROVEEDORES -->
        <div class="col-md-6 mb-4">
            <h5 class="text-success mb-3">Proveedores</h5>
            <form id="formProveedor" class="mb-3">
                <div class="row g-2">
                    <div class="col-12"><input type="text" id="empresa" class="form-control" placeholder="Nombre Empresa" required></div>
                    <div class="col-12"><input type="text" id="contacto" class="form-control" placeholder="Nombre Contacto"></div>
                    <div class="col-12"><input type="text" id="cargo" class="form-control" placeholder="Cargo Contacto"></div>
                    <div class="col-12"><input type="text" id="direccion" class="form-control" placeholder="Direcci√≥n"></div>
                    <div class="col-6"><input type="text" id="ciudad" class="form-control" placeholder="Ciudad"></div>
                    <div class="col-6"><input type="text" id="pais" class="form-control" placeholder="Pa√≠s"></div>
                </div>
                <div class="mt-2 text-center">
                    <button type="submit" class="btn btn-success w-100">Guardar Proveedor</button>
                </div>
            </form>

            <div class="table-responsive">
                <table class="table table-bordered text-center align-middle">
                    <thead class="table-success">
                        <tr>
                            <th>ID</th><th>Empresa</th><th>Contacto</th><th>Cargo</th>
                            <th>Direcci√≥n</th><th>Ciudad</th><th>Pa√≠s</th><th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tablaProveedores"></tbody>
                </table>
            </div>
        </div>

        <!-- PANEL COMPRAS -->
        <div class="col-md-6 mb-4">
            <h5 class="text-success mb-3">Registrar Compras</h5>
            <form id="formCompra" class="mb-3">
                <div class="mb-2">
                    <input type="text" id="producto" class="form-control" placeholder="Nombre Producto" required>
                </div>
                <div class="mb-2">
                    <input type="number" id="cantidad" class="form-control" placeholder="Cantidad" required min="1">
                </div>
                <div class="mb-2">
                    <select id="selectProveedor" class="form-select" required></select>
                </div>
                <div class="mb-2">
                    <input type="date" id="fecha" class="form-control" required>
                </div>
                <div class="text-center">
                    <button type="submit" class="btn btn-success w-100">Guardar Compra</button>
                </div>
            </form>

            <div class="table-responsive">
                <table class="table table-bordered text-center align-middle">
                    <thead class="table-success">
                        <tr>
                            <th>Producto</th><th>Cantidad</th><th>Proveedor</th><th>Fecha</th>
                        </tr>
                    </thead>
                    <tbody id="tablaCompras"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const formProveedor = document.getElementById('formProveedor');
const tablaProveedores = document.getElementById('tablaProveedores');
const selectProveedor = document.getElementById('selectProveedor');
const alerta = document.getElementById('alerta');

const formCompra = document.getElementById('formCompra');
const tablaCompras = document.getElementById('tablaCompras');

let compras = [];

// üîπ Funciones Proveedores
async function cargarProveedores(){
    try {
        const res = await fetch('/admin/api/proveedores');
        const data = await res.json();
        if(!Array.isArray(data)) throw new Error("JSON inv√°lido");
        tablaProveedores.innerHTML = '';
        selectProveedor.innerHTML = '';
        data.forEach(p => {
            tablaProveedores.innerHTML += `
            <tr>
                <td>${p.id}</td>
                <td>${p.empresa}</td>
                <td>${p.contacto}</td>
                <td>${p.cargo}</td>
                <td>${p.direccion}</td>
                <td>${p.ciudad}</td>
                <td>${p.pais}</td>
                <td>
                    <button class="btn btn-warning btn-sm me-1" onclick="editarProveedor(${p.id})">Editar</button>
                    <button class="btn btn-danger btn-sm" onclick="eliminarProveedor(${p.id})">Eliminar</button>
                </td>
            </tr>`;
            selectProveedor.innerHTML += `<option value="${p.empresa}">${p.empresa}</option>`;
        });
    } catch(e){
        mostrarAlerta("Error al cargar proveedores ‚ùå", "danger");
        console.error(e);
    }
}

formProveedor.addEventListener('submit', async e => {
    e.preventDefault();
    const nuevo = {
        empresa: document.getElementById('empresa').value,
        contacto: document.getElementById('contacto').value,
        cargo: document.getElementById('cargo').value,
        direccion: document.getElementById('direccion').value,
        ciudad: document.getElementById('ciudad').value,
        pais: document.getElementById('pais').value
    };
    try{
        const res = await fetch('/admin/api/proveedores', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify(nuevo)
        });
        const data = await res.json();
        mostrarAlerta(data.mensaje, res.ok ? 'success':'danger');
        formProveedor.reset();
        cargarProveedores();
    } catch(e){
        mostrarAlerta("Error al guardar proveedor ‚ùå",'danger');
        console.error(e);
    }
});

async function eliminarProveedor(id){
    if(!confirm("¬øSeguro que deseas eliminar este proveedor?")) return;
    try{
        const res = await fetch(`/admin/api/proveedores/${id}`, {method:'DELETE'});
        const data = await res.json();
        mostrarAlerta(data.mensaje, res.ok ? 'success':'danger');
        cargarProveedores();
    } catch(e){
        mostrarAlerta("Error en conexi√≥n ‚ùå",'danger');
    }
}

function editarProveedor(id){
    alert("Funci√≥n de edici√≥n a√∫n no implementada (ID: "+id+")");
}

// üîπ Funciones Compras
formCompra.addEventListener('submit', e => {
    e.preventDefault();
    const compra = {
        producto: document.getElementById('producto').value,
        cantidad: document.getElementById('cantidad').value,
        proveedor: selectProveedor.value,
        fecha: document.getElementById('fecha').value
    };
    compras.push(compra);
    actualizarTablaCompras();
    formCompra.reset();
});

function actualizarTablaCompras(){
    tablaCompras.innerHTML = '';
    compras.forEach(c=>{
        tablaCompras.innerHTML += `
        <tr>
            <td>${c.producto}</td>
            <td>${c.cantidad}</td>
            <td>${c.proveedor}</td>
            <td>${c.fecha}</td>
        </tr>`;
    });
}

// üîπ Alertas
function mostrarAlerta(msg,tipo){
    alerta.className = `alert alert-${tipo}`;
    alerta.textContent = msg;
    alerta.style.display='block';
    setTimeout(()=>alerta.style.display='none',3000);
}

// Inicializar
cargarProveedores();
</script>
{% endblock %}
