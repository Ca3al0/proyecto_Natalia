{% extends "common/base.html" %}

{% block title %}Gestión de Proveedores{% endblock %}

{% block content %}
<div class="container mt-5 p-4 bg-white rounded shadow">
    <h3 class="text-center text-success mb-4">Gestión de Proveedores</h3>

    <div id="alerta" class="alert text-center" style="display:none;"></div>

    <!-- Formulario -->
    <form id="formProveedor" class="mb-4">
        <div class="row g-3">
            <div class="col-md-4"><input type="text" id="empresa" class="form-control" placeholder="Nombre Empresa" required></div>
            <div class="col-md-4"><input type="text" id="contacto" class="form-control" placeholder="Nombre Contacto" required></div>
            <div class="col-md-4"><input type="text" id="cargo" class="form-control" placeholder="Cargo Contacto" required></div>
            <div class="col-md-4"><input type="text" id="direccion" class="form-control" placeholder="Dirección" required></div>
            <div class="col-md-4"><input type="text" id="ciudad" class="form-control" placeholder="Ciudad" required></div>
            <div class="col-md-4"><input type="text" id="pais" class="form-control" placeholder="País" required></div>
        </div>
        <div class="mt-3 text-center">
            <button type="submit" class="btn btn-success">Guardar Proveedor</button>
        </div>
    </form>

    <!-- Tabla -->
    <div class="table-responsive">
        <table class="table table-bordered text-center align-middle">
            <thead class="table-success">
                <tr>
                    <th>ID</th><th>Empresa</th><th>Contacto</th><th>Cargo</th>
                    <th>Dirección</th><th>Ciudad</th><th>País</th><th>Acciones</th>
                </tr>
            </thead>
            <tbody id="tablaProveedores"></tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const form = document.getElementById('formProveedor');
const tabla = document.getElementById('tablaProveedores');
const alerta = document.getElementById('alerta');

async function cargarProveedores(){
    try {
        const res = await fetch('/admin/api/proveedores');
        const data = await res.json();
        if(!Array.isArray(data)) throw new Error("JSON inválido");
        tabla.innerHTML = '';
        data.forEach(p => {
            tabla.innerHTML += `
            <tr>
                <td>${p.id}</td>
                <td>${p.empresa}</td>
                <td>${p.contacto}</td>
                <td>${p.cargo}</td>
                <td>${p.direccion}</td>
                <td>${p.ciudad}</td>
                <td>${p.pais}</td>
                <td>
                    <button class="btn btn-warning btn-sm me-1" onclick="editar(${p.id})">Editar</button>
                    <button class="btn btn-danger btn-sm" onclick="eliminar(${p.id})">Eliminar</button>
                </td>
            </tr>`;
        });
    } catch(e){
        mostrarAlerta("Error al cargar proveedores ❌", "danger");
        console.error(e);
    }
}

form.addEventListener('submit', async e=>{
    e.preventDefault();
    const nuevo = {
        empresa: document.getElementById('empresa').value,
        contacto: document.getElementById('contacto').value,
        cargo: document.getElementById('cargo').value,
        direccion: document.getElementById('direccion').value,
        ciudad: document.getElementById('ciudad').value,
        pais: document.getElementById('pais').value
    };
    try{
        const res = await fetch('/admin/api/proveedores', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(nuevo)
        });
        const data = await res.json();
        if(res.ok){
            mostrarAlerta(data.mensaje,'success');
            form.reset();
            cargarProveedores();
        } else mostrarAlerta(data.mensaje,'danger');
    } catch(e){
        mostrarAlerta("Error al guardar proveedor ❌",'danger');
        console.error(e);
    }
});

async function eliminar(id){
    if(!confirm("¿Seguro que deseas eliminar este proveedor?")) return;
    try{
        const res = await fetch(`/admin/api/proveedores/${id}`, {method:'DELETE'});
        const data = await res.json();
        mostrarAlerta(data.mensaje, res.ok ? 'success':'danger');
        cargarProveedores();
    } catch(e){
        mostrarAlerta("Error en conexión ❌",'danger');
    }
}

function editar(id){
    alert("Función de edición aún no implementada (ID: "+id+")");
}

function mostrarAlerta(msg,tipo){
    alerta.className = `alert alert-${tipo}`;
    alerta.textContent = msg;
    alerta.style.display='block';
    setTimeout(()=>alerta.style.display='none',3000);
}

cargarProveedores();
</script>
{% endblock %}
