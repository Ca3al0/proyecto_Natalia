{% extends "common/base.html" %}

{% block content %}
<div class="container mt-5 pt-4">
  <h2 class="mb-4 text-center text-success fw-bold">Gesti√≥n de Proveedores</h2>

  <!-- Bot√≥n para agregar proveedor -->
  <div class="d-flex justify-content-end mb-3">
    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalProveedor">
      <i class="bi bi-person-plus"></i> Nuevo Proveedor
    </button>
  </div>

  <!-- Tabla de proveedores -->
  <div class="table-responsive shadow rounded">
    <table class="table table-striped align-middle" id="tablaProveedores">
      <thead class="table-success text-center">
        <tr>
          <th>ID</th>
          <th>Empresa</th>
          <th>Contacto</th>
          <th>Tel√©fono</th>
          <th>Pa√≠s</th>
          <th>Cargo</th>
          <th>Cantidad</th>
          <th>Precio Unitario</th>
          <th>Ciudad</th>
          <th>Direcci√≥n</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody class="text-center"></tbody>
    </table>
  </div>
</div>

<!-- Modal para agregar/editar proveedor -->
<div class="modal fade" id="modalProveedor" tabindex="-1" aria-labelledby="modalProveedorLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="modalProveedorLabel">Agregar Proveedor</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <form id="formProveedor">
          <input type="hidden" id="idProveedor">

          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Empresa</label>
              <input type="text" class="form-control" id="empresa" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Contacto</label>
              <input type="text" class="form-control" id="contacto">
            </div>
            <div class="col-md-6">
              <label class="form-label">Tel√©fono</label>
              <input type="text" class="form-control" id="telefono">
            </div>
            <div class="col-md-6">
              <label class="form-label">Pa√≠s</label>
              <input type="text" class="form-control" id="pais">
            </div>
            <div class="col-md-6">
              <label class="form-label">Cargo</label>
              <input type="text" class="form-control" id="cargo">
            </div>
            <div class="col-md-3">
              <label class="form-label">Cantidad</label>
              <input type="number" step="0.01" class="form-control" id="cantidad">
            </div>
            <div class="col-md-3">
              <label class="form-label">Precio Unitario</label>
              <input type="number" step="0.01" class="form-control" id="precio">
            </div>
            <div class="col-md-6">
              <label class="form-label">Ciudad</label>
              <input type="text" class="form-control" id="ciudad">
            </div>
            <div class="col-md-12">
              <label class="form-label">Direcci√≥n</label>
              <input type="text" class="form-control" id="direccion">
            </div>
          </div>

          <div class="mt-4 text-end">
            <button type="submit" class="btn btn-success">Guardar</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
// üì¶ Cargar proveedores
function cargarProveedores() {
  fetch('/api/proveedores')
    .then(res => res.json())
    .then(data => {
      const tbody = document.querySelector("#tablaProveedores tbody");
      tbody.innerHTML = "";
      data.forEach(p => {
        const fila = `
          <tr>
            <td>${p.id}</td>
            <td>${p.empresa}</td>
            <td>${p.contacto}</td>
            <td>${p.telefono}</td>
            <td>${p.pais}</td>
            <td>${p.cargo}</td>
            <td>${p.cantidad ?? ''}</td>
            <td>${p.precio ?? ''}</td>
            <td>${p.ciudad}</td>
            <td>${p.direccion}</td>
            <td>
              <button class="btn btn-sm btn-warning" onclick="editarProveedor(${p.id})">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="btn btn-sm btn-danger" onclick="eliminarProveedor(${p.id})">
                <i class="bi bi-trash"></i>
              </button>
            </td>
          </tr>`;
        tbody.innerHTML += fila;
      });
    });
}

// üü¢ Guardar proveedor (nuevo o editado)
document.getElementById("formProveedor").addEventListener("submit", function(e) {
  e.preventDefault();
  const id = document.getElementById("idProveedor").value;
  const data = {
    empresa: document.getElementById("empresa").value,
    contacto: document.getElementById("contacto").value,
    telefono: document.getElementById("telefono").value,
    pais: document.getElementById("pais").value,
    cargo: document.getElementById("cargo").value,
    cantidad: parseFloat(document.getElementById("cantidad").value) || 0,
    precio: parseFloat(document.getElementById("precio").value) || 0,
    ciudad: document.getElementById("ciudad").value,
    direccion: document.getElementById("direccion").value
  };

  const metodo = id ? "PUT" : "POST";
  const url = id ? `/api/proveedores/${id}` : "/api/proveedores";

  fetch(url, {
    method: metodo,
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data)
  })
    .then(res => res.json())
    .then(() => {
      cargarProveedores();
      bootstrap.Modal.getInstance(document.getElementById("modalProveedor")).hide();
      document.getElementById("formProveedor").reset();
      document.getElementById("idProveedor").value = "";
    });
});

// ‚úèÔ∏è Editar proveedor
function editarProveedor(id) {
  fetch(`/api/proveedores`)
    .then(res => res.json())
    .then(data => {
      const p = data.find(x => x.id === id);
      if (!p) return;
      document.getElementById("modalProveedorLabel").textContent = "Editar Proveedor";
      document.getElementById("idProveedor").value = p.id;
      document.getElementById("empresa").value = p.empresa;
      document.getElementById("contacto").value = p.contacto;
      document.getElementById("telefono").value = p.telefono;
      document.getElementById("pais").value = p.pais;
      document.getElementById("cargo").value = p.cargo;
      document.getElementById("cantidad").value = p.cantidad;
      document.getElementById("precio").value = p.precio;
      document.getElementById("ciudad").value = p.ciudad;
      document.getElementById("direccion").value = p.direccion;
      new bootstrap.Modal(document.getElementById("modalProveedor")).show();
    });
}

// üóëÔ∏è Eliminar proveedor
function eliminarProveedor(id) {
  if (!confirm("¬øSeguro que deseas eliminar este proveedor?")) return;
  fetch(`/api/proveedores/${id}`, { method: "DELETE" })
    .then(res => res.json())
    .then(() => cargarProveedores());
}

document.addEventListener("DOMContentLoaded", cargarProveedores);
</script>
{% endblock %}
