{% extends "common/base.html" %}

{% block title %}Gesti√≥n de Proveedores - Casa en el √Årbol{% endblock %}

{% block content %}
<div class="container mt-5 mb-5 p-4 bg-white rounded shadow">
  <h3 class="text-center text-success fw-bold mb-4">
    Gesti√≥n de Proveedores
  </h3>

  <!-- ALERTAS -->
  <div id="alerta" class="alert text-center" role="alert" style="display: none;"></div>

  <!-- FORMULARIO DE PROVEEDORES -->
  <form id="formProveedor" class="mb-4">
    <div class="row g-3">
      <div class="col-md-4">
        <label class="form-label fw-semibold">Nombre Empresa</label>
        <input type="text" id="empresa" class="form-control" required>
      </div>
      <div class="col-md-4">
        <label class="form-label fw-semibold">Nombre Contacto</label>
        <input type="text" id="contacto" class="form-control" required>
      </div>
      <div class="col-md-4">
        <label class="form-label fw-semibold">Cargo Contacto</label>
        <input type="text" id="cargo" class="form-control" required>
      </div>
      <div class="col-md-4">
        <label class="form-label fw-semibold">Direcci√≥n</label>
        <input type="text" id="direccion" class="form-control" required>
      </div>
      <div class="col-md-4">
        <label class="form-label fw-semibold">Ciudad</label>
        <input type="text" id="ciudad" class="form-control" required>
      </div>
      <div class="col-md-4">
        <label class="form-label fw-semibold">Pa√≠s</label>
        <input type="text" id="pais" class="form-control" required>
      </div>
    </div>

    <div class="mt-4 text-center">
      <button type="submit" class="btn btn-success px-4">
        <i class="bi bi-save"></i> Guardar Proveedor
      </button>
    </div>
  </form>

  <!-- TABLA DE PROVEEDORES -->
  <div class="table-responsive">
    <table class="table table-bordered align-middle text-center">
      <thead class="table-success">
        <tr>
          <th>ID</th>
          <th>Empresa</th>
          <th>Contacto</th>
          <th>Cargo</th>
          <th>Direcci√≥n</th>
          <th>Ciudad</th>
          <th>Pa√≠s</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="tablaProveedores"></tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  const form = document.getElementById('formProveedor');
  const tabla = document.getElementById('tablaProveedores');
  const alerta = document.getElementById('alerta');

  // üîÑ Cargar proveedores al iniciar
  async function cargarProveedores() {
    try {
      const res = await fetch('/api/proveedores');
      const data = await res.json();
      tabla.innerHTML = '';
      data.forEach(p => {
        tabla.innerHTML += `
          <tr>
            <td>${p.id}</td>
            <td>${p.empresa}</td>
            <td>${p.contacto}</td>
            <td>${p.cargo}</td>
            <td>${p.direccion}</td>
            <td>${p.ciudad}</td>
            <td>${p.pais}</td>
            <td>
              <button class="btn btn-warning btn-sm me-1" onclick="editar(${p.id})">
                <i class="bi bi-pencil-square"></i>
              </button>
              <button class="btn btn-danger btn-sm" onclick="eliminar(${p.id})">
                <i class="bi bi-trash3"></i>
              </button>
            </td>
          </tr>`;
      });
    } catch (error) {
      mostrarAlerta("Error al cargar los proveedores ‚ùå", "danger");
      console.error(error);
    }
  }

  // ‚úÖ Agregar proveedor
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const nuevoProveedor = {
      empresa: document.getElementById('empresa').value,
      contacto: document.getElementById('contacto').value,
      cargo: document.getElementById('cargo').value,
      direccion: document.getElementById('direccion').value,
      ciudad: document.getElementById('ciudad').value,
      pais: document.getElementById('pais').value
    };

    try {
      const res = await fetch('/api/proveedores', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(nuevoProveedor)
      });

      const data = await res.json();
      if (res.ok) {
        mostrarAlerta(data.mensaje, 'success');
        form.reset();
        cargarProveedores();
      } else {
        mostrarAlerta(data.mensaje, 'danger');
      }
    } catch (error) {
      mostrarAlerta("Error al guardar el proveedor ‚ùå", 'danger');
      console.error(error);
    }
  });

  // üóëÔ∏è Eliminar proveedor
  async function eliminar(id) {
    if (!confirm("¬øSeguro que deseas eliminar este proveedor?")) return;
    try {
      const res = await fetch(`/api/proveedores/${id}`, { method: 'DELETE' });
      const data = await res.json();
      if (res.ok) {
        mostrarAlerta(data.mensaje, 'success');
        cargarProveedores();
      } else {
        mostrarAlerta("Error al eliminar el proveedor ‚ùå", 'danger');
      }
    } catch (error) {
      mostrarAlerta("Error en la conexi√≥n al eliminar ‚ùå", 'danger');
    }
  }

  // ‚öôÔ∏è Editar (placeholder)
  function editar(id) {
    alert("Funci√≥n de edici√≥n a√∫n no implementada (Proveedor ID: " + id + ")");
  }

  // üîî Mostrar alertas
  function mostrarAlerta(mensaje, tipo) {
    alerta.className = `alert alert-${tipo}`;
    alerta.textContent = mensaje;
    alerta.style.display = 'block';
    setTimeout(() => alerta.style.display = 'none', 3000);
  }

  cargarProveedores();
</script>
{% endblock %}
