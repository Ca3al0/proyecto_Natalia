{% extends "common/base.html" %}

{% block title %}Gestión de Proveedores y Compras{% endblock %}

{% block content %}
<div class="container mt-5 p-4 bg-light rounded-4 shadow-sm">

    <h3 class="text-center text-success mb-5 fw-bold">Gestión de Proveedores y Compras</h3>

    <div id="alerta" class="alert text-center" style="display:none;"></div>

    <div class="row g-4">
        <!-- PANEL PROVEEDORES -->
        <div class="col-12">
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-body">
                    <h5 class="text-success mb-4 fw-bold text-center">Proveedores</h5>
                    <form id="formProveedor" class="mb-4">
                        <div class="row g-2">
                            <div class="col-md-4"><input type="text" id="empresa" class="form-control rounded-pill shadow-sm" placeholder="Nombre Empresa" required></div>
                            <div class="col-md-4"><input type="text" id="contacto" class="form-control rounded-pill shadow-sm" placeholder="Nombre Contacto" required></div>
                            <div class="col-md-4"><input type="text" id="cargo" class="form-control rounded-pill shadow-sm" placeholder="Cargo Contacto"></div>
                            <div class="col-md-4"><input type="text" id="direccion" class="form-control rounded-pill shadow-sm" placeholder="Dirección"></div>
                            <div class="col-md-4"><input type="text" id="ciudad" class="form-control rounded-pill shadow-sm" placeholder="Ciudad"></div>
                            <div class="col-md-4"><input type="text" id="pais" class="form-control rounded-pill shadow-sm" placeholder="País"></div>
                        </div>
                        <div class="mt-3 text-center">
                            <button type="submit" class="btn btn-success w-50 fw-bold shadow-sm" style="border-radius:50px;">Guardar Proveedor</button>
                        </div>
                    </form>

                    <div class="table-responsive">
                        <table class="table table-hover text-center align-middle w-100" style="min-width: 900px;">
                            <thead class="table-success text-dark fw-bold">
                                <tr>
                                    <th>ID</th>
                                    <th>Empresa</th>
                                    <th>Contacto</th>
                                    <th>Cargo</th>
                                    <th>Dirección</th>
                                    <th>Ciudad</th>
                                    <th>País</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tablaProveedores"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- PANEL COMPRAS -->
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <h5 class="text-success mb-4 fw-bold text-center">Registrar Compras</h5>
                    <form id="formCompra" class="mb-4">
                        <div class="row g-2">
                            <div class="col-md-3"><input type="text" id="producto" class="form-control rounded-pill shadow-sm" placeholder="Producto" required></div>
                            <div class="col-md-2"><input type="number" id="cantidad" class="form-control rounded-pill shadow-sm" placeholder="Cantidad" required min="1"></div>
                            <div class="col-md-3">
                                <select id="selectProveedor" class="form-select rounded-pill shadow-sm" required></select>
                            </div>
                            <div class="col-md-2"><input type="date" id="fecha" class="form-control rounded-pill shadow-sm" required></div>
                            <div class="col-md-2 d-grid"><button type="submit" class="btn btn-success rounded-pill fw-bold shadow-sm">Guardar</button></div>
                        </div>
                    </form>

                    <div class="table-responsive">
                        <table class="table table-hover text-center align-middle w-100" style="min-width: 700px;">
                            <thead class="table-success text-dark fw-bold">
                                <tr>
                                    <th>Producto</th>
                                    <th>Cantidad</th>
                                    <th>Proveedor</th>
                                    <th>Fecha</th>
                                </tr>
                            </thead>
                            <tbody id="tablaCompras"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// VARIABLES
const formProveedor = document.getElementById('formProveedor');
const tablaProveedores = document.getElementById('tablaProveedores');
const selectProveedor = document.getElementById('selectProveedor');
const alerta = document.getElementById('alerta');

const formCompra = document.getElementById('formCompra');
const tablaCompras = document.getElementById('tablaCompras');

// CARGAR PROVEEDORES
async function cargarProveedores(){
    try {
        const res = await fetch('/admin/api/proveedores');
        const data = await res.json();
        if(!Array.isArray(data)) throw new Error("JSON inválido");
        tablaProveedores.innerHTML = '';
        selectProveedor.innerHTML = '';
        data.forEach(p => {
            tablaProveedores.innerHTML += `
            <tr>
                <td>${p.id}</td>
                <td>${p.empresa}</td>
                <td>${p.contacto}</td>
                <td>${p.cargo}</td>
                <td>${p.direccion}</td>
                <td>${p.ciudad}</td>
                <td>${p.pais}</td>
                <td>
                    <button class="btn btn-warning btn-sm me-1" onclick="editarProveedor(${p.id})">Editar</button>
                    <button class="btn btn-danger btn-sm" onclick="eliminarProveedor(${p.id})">Eliminar</button>
                </td>
            </tr>`;
            selectProveedor.innerHTML += `<option value="${p.id}">${p.empresa}</option>`;
        });
        cargarCompras(); // recargar compras al cargar proveedores
    } catch(e){
        mostrarAlerta("Error al cargar proveedores ❌", "danger");
        console.error(e);
    }
}

// EVENTO GUARDAR PROVEEDOR
formProveedor.addEventListener('submit', async e => {
    e.preventDefault();
    const nuevo = {
        empresa: document.getElementById('empresa').value,
        contacto: document.getElementById('contacto').value,
        cargo: document.getElementById('cargo').value,
        direccion: document.getElementById('direccion').value,
        ciudad: document.getElementById('ciudad').value,
        pais: document.getElementById('pais').value
    };
    try{
        const res = await fetch('/admin/api/proveedores', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify(nuevo)
        });
        const data = await res.json();
        mostrarAlerta(data.mensaje, res.ok ? 'success':'danger');
        formProveedor.reset();
        cargarProveedores();
    } catch(e){
        mostrarAlerta("Error al guardar proveedor ❌",'danger');
        console.error(e);
    }
});

// ELIMINAR PROVEEDOR
async function eliminarProveedor(id){
    if(!confirm("¿Seguro que deseas eliminar este proveedor?")) return;
    try{
        const res = await fetch(`/admin/api/proveedores/${id}`, {method:'DELETE'});
        const data = await res.json();
        mostrarAlerta(data.mensaje, res.ok ? 'success':'danger');
        cargarProveedores();
    } catch(e){
        mostrarAlerta("Error en conexión ❌",'danger');
    }
}

function editarProveedor(id){
    alert("Función de edición aún no implementada (ID: "+id+")");
}

// GUARDAR COMPRA
formCompra.addEventListener('submit', async e => {
    e.preventDefault();
    const compra = {
        producto: document.getElementById('producto').value,
        cantidad: document.getElementById('cantidad').value,
        proveedor: selectProveedor.value,
        fecha: document.getElementById('fecha').value
    };
    try {
        const res = await fetch('/admin/api/compras', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify(compra)
        });
        const data = await res.json();
        mostrarAlerta(data.mensaje, res.ok ? 'success':'danger');
        if(res.ok){
            cargarCompras();
            formCompra.reset();
        }
    } catch(e){
        mostrarAlerta("Error al guardar la compra ❌", 'danger');
        console.error(e);
    }
});

// CARGAR COMPRAS DESDE LA BD
async function cargarCompras(){
    try {
        const res = await fetch('/admin/api/compras');
        const data = await res.json();
        tablaCompras.innerHTML = '';
        data.forEach(c=>{
            tablaCompras.innerHTML += `
            <tr>
                <td>${c.producto}</td>
                <td>${c.cantidad}</td>
                <td>${c.proveedor}</td>
                <td>${c.fecha}</td>
            </tr>`;
        });
    } catch(e){
        mostrarAlerta("Error al cargar compras ❌", 'danger');
        console.error(e);
    }
}

// ALERTAS
function mostrarAlerta(msg,tipo){
    alerta.className = `alert alert-${tipo}`;
    alerta.textContent = msg;
    alerta.style.display='block';
    setTimeout(()=>alerta.style.display='none',3000);
}

// INICIALIZAR
cargarProveedores();
</script>
{% endblock %}
