{% extends "common/base.html" %}

{% block content %}
<div class="container mt-5">
    <h2 class="mb-4 text-primary">游 Tu Carrito de Compras</h2>
    
    <div id="lista-carrito" class="row g-4 mb-4">
    </div>
    
    <div class="d-flex justify-content-between align-items-center mb-5">
        <button id="vaciar-carrito" class="btn btn-danger btn-lg shadow">
            <i class="bi bi-trash me-2"></i> Vaciar Carrito
        </button>
        <h3 class="m-0">Total: <span class="text-success fw-bold" id="carrito-total">$0.00</span></h3>
    </div>
    
    <div class="text-end">
        <a href="{{ url_for('cliente.checkout') }}" id="btn-checkout" class="btn btn-success btn-lg shadow">
            <i class="bi bi-credit-card me-2"></i> Proceder al Pago
        </a>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Usamos 'let' para 'carrito' porque ser치 reasignado al vaciarlo.
    let carrito = JSON.parse(localStorage.getItem('carrito') || '[]');
    
    // Referencias DOM
    const listaCarritoDOM = document.getElementById('lista-carrito');
    const carritoTotalDOM = document.getElementById('carrito-total');
    const vaciarCarritoBtn = document.getElementById('vaciar-carrito');
    const checkoutContainer = document.querySelector('.text-end'); // Contenedor del bot칩n de pago
    const checkoutBtn = document.getElementById('btn-checkout');

    // --- Funciones del Carrito ---

    /**
     * Calcula y actualiza el total a pagar en el DOM.
     */
    const actualizarTotal = () => {
        const total = carrito.reduce((sum, item) => {
            const precio = parseFloat(item.precio || 0);
            const cantidad = parseInt(item.cantidad || 1);
            return sum + (precio * cantidad);
        }, 0);
        carritoTotalDOM.textContent = `$${total.toFixed(2)}`;
    };

    /**
     * Renderiza todos los productos del carrito y adjunta event listeners.
     */
    const renderizarCarrito = () => {
        listaCarritoDOM.innerHTML = '';

        if (carrito.length === 0) {
            listaCarritoDOM.innerHTML = `
                <div class="col-12">
                    <div class="alert alert-info text-center" role="alert">
                        <i class="bi bi-info-circle me-2"></i> El carrito est치 vac칤o. 춰A침ade productos!
                    </div>
                </div>
            `;
            carritoTotalDOM.textContent = '$0.00';
            checkoutContainer.style.display = 'none';
            vaciarCarritoBtn.disabled = true;
            return;
        } 
        
        // Habilitar si hay items
        checkoutContainer.style.display = 'block';
        vaciarCarritoBtn.disabled = false;


        carrito.forEach((item, index) => {
            const precio = parseFloat(item.precio || 0);
            const cantidad = parseInt(item.cantidad || 1);

            const col = document.createElement('div');
            // Usamos template literal para la sintaxis del HTML
            col.className = 'col-12 col-md-6 col-lg-4';
            col.innerHTML = `
                <div class="card h-100 shadow-sm border-0">
                    <img src="${item.imagen || '{{ url_for('static', filename='img/catalogo.png') }}'}" 
                        class="card-img-top p-3" 
                        alt="${item.nombre}" 
                        style="height: 200px; object-fit: contain;"
                    >
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title text-primary">${item.nombre}</h5>
                        <p class="card-text mb-1">Precio Unitario: <span class="fw-bold">$${precio.toFixed(2)}</span></p>
                        <p class="card-text mb-3">Subtotal: 
                            <span class="fw-bold text-success">$<span data-subtotal-index="${index}">${(precio * cantidad).toFixed(2)}</span></span>
                        </p>

                        <div class="d-flex align-items-center gap-3 mb-3 mt-auto">
                            <label for="cantidad-item-${index}" class="form-label mb-0">Cantidad:</label>
                            <input type="number" 
                                min="1" 
                                value="${cantidad}" 
                                class="form-control form-control-sm w-50 input-cantidad" 
                                data-index="${index}"
                                id="cantidad-item-${index}"
                            >
                        </div>
                        <button class="btn btn-outline-danger btn-eliminar" data-index="${index}">
                            <i class="bi bi-x-circle me-1"></i> Eliminar
                        </button>
                    </div>
                </div>
            `;

            listaCarritoDOM.appendChild(col);

            // Se adjunta el evento al input
            const inputCantidad = col.querySelector('.input-cantidad');
            inputCantidad.addEventListener('change', (e) => handleCantidadChange(e, precio));

            // Se adjunta el evento al bot칩n de eliminar
            col.querySelector('.btn-eliminar').addEventListener('click', (e) => handleEliminarClick(e, index));
        });

        // Siempre actualizar el total despu칠s de renderizar
        actualizarTotal();
    };
    
    /**
     * Maneja el cambio de cantidad de un 칤tem.
     */
    const handleCantidadChange = (event, precioUnitario) => {
        const input = event.target;
        const index = parseInt(input.getAttribute('data-index'));
        let nuevaCantidad = parseInt(input.value);

        // Aseguramos que la cantidad es v치lida
        if (isNaN(nuevaCantidad) || nuevaCantidad < 1) {
            nuevaCantidad = 1;
            input.value = 1; // Corregir visualmente el input
        }
            
        // 1. Actualiza el modelo (array carrito)
        carrito[index].cantidad = nuevaCantidad; 
        
        // 2. Persiste en el almacenamiento local
        localStorage.setItem('carrito', JSON.stringify(carrito));
        
        // 3. Actualiza el subtotal del 칤tem en el DOM
        const nuevoSubtotal = (precioUnitario * nuevaCantidad).toFixed(2);
        document.querySelector(`[data-subtotal-index="${index}"]`).textContent = nuevoSubtotal;

        // 4. Actualiza el total general
        actualizarTotal();
    };
    
    /**
     * Maneja el click en el bot칩n Eliminar.
     */
    const handleEliminarClick = (event, indexToRemove) => {
        // Usamos el index pasado para una eliminaci칩n precisa
        carrito.splice(indexToRemove, 1);
        localStorage.setItem('carrito', JSON.stringify(carrito));
        // Recargar la vista completa para reindexar y refrescar eventos
        renderizarCarrito(); 
    };


    // --- Evento Vaciar Carrito ---
    vaciarCarritoBtn.addEventListener('click', () => {
        if (carrito.length > 0 && confirm('쮼st치 seguro que desea vaciar su carrito? Esta acci칩n no se puede deshacer.')) {
            carrito = [];
            localStorage.setItem('carrito', JSON.stringify(carrito));
            renderizarCarrito();
        }
    });

    // --- Inicializaci칩n ---
    renderizarCarrito();
});
</script>
{% endblock %}