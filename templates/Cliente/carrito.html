{% extends "common/base.html" %}

{% block content %}
<div class="container mt-5">
 <h2 class="mb-4 text-primary">游 Tu Carrito de Compras</h2>
 
 <div id="lista-carrito" class="row g-4 mb-4">
   </div>

 <div class="d-flex justify-content-between align-items-center mb-5">
  <button id="vaciar-carrito" class="btn btn-danger btn-lg shadow">
   <i class="bi bi-trash me-2"></i> Vaciar Carrito
  </button>
  <h3 class="m-0">Total: <span class="text-success fw-bold" id="carrito-total">$0.00</span></h3>
 </div>
 
  <div class="text-end">
  <a href="{{ url_for('cliente.checkout') }}" class="btn btn-success btn-xl shadow">
   <i class="bi bi-credit-card me-2"></i> Proceder al Pago
  </a>
 </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
 // **NOTA IMPORTANTE:**
 // El carrito en localStorage probablemente solo guarda IDs (ej: ['1', '5', '1', '2']).
 // Para que este c칩digo funcione, DEBE guardar objetos completos (ej: [{id:'1', nombre:'Producto A', precio: 10.50, imagen: '/img/a.png', cantidad: 1}]).
 // Asumiremos que el c칩digo de "Agregar al carrito" fue corregido para guardar la estructura de objetos.

 let carrito = JSON.parse(localStorage.getItem('carrito') || '[]');

 // --- Funciones del Carrito ---

 const actualizarTotal = () => {
  const total = carrito.reduce((sum, item) => sum + (parseFloat(item.precio) * parseInt(item.cantidad)), 0);
  document.getElementById('carrito-total').textContent = `$${total.toFixed(2)}`;
 };

 const renderizarCarrito = () => {
  const lista = document.getElementById('lista-carrito');
  lista.innerHTML = '';

  if(carrito.length === 0){
   lista.innerHTML = '<div class="col-12"><div class="alert alert-info" role="alert"><i class="bi bi-info-circle me-2"></i>El carrito est치 vac칤o.</div></div>';
   document.getElementById('carrito-total').textContent = '$0.00';
   // Ocultar el bot칩n de pago si est치 vac칤o
   document.querySelector('.text-end').style.display = 'none';
   return;
  } else {
   document.querySelector('.text-end').style.display = 'block';
  }

  carrito.forEach((item, index) => {
   // Aseguramos que los valores son n칰meros con .toFixed(2)
   const precio = parseFloat(item.precio || 0); 
   const cantidad = parseInt(item.cantidad || 1); 

   const col = document.createElement('div');
   col.className = 'col-12 col-md-6 col-lg-4';

   col.innerHTML = `
    <div class="card h-100 shadow-sm border-0">
     <img src="${item.imagen || '{{ url_for('static', filename='img/catalogo.png') }}'}" class="card-img-top p-3" alt="${item.nombre}" style="height: 200px; object-fit: contain;">
     <div class="card-body d-flex flex-column">
      <h5 class="card-title text-primary">${item.nombre}</h5>
      <p class="card-text mb-1">Precio Unitario: <span class="fw-bold">$${precio.toFixed(2)}</span></p>
      <p class="card-text mb-3">Subtotal: <span class="fw-bold text-success">$<span id="subtotal-${index}">${(precio * cantidad).toFixed(2)}</span></span></p>

      <div class="d-flex align-items-center gap-3 mb-3 mt-auto">
       <label for="cantidad-${index}" class="form-label mb-0">Cantidad:</label>
       <input type="number" min="1" value="${cantidad}" class="form-control form-control-sm w-50" id="cantidad-${index}">
      </div>
      <button class="btn btn-outline-danger btn-eliminar" data-index="${index}">
       <i class="bi bi-x-circle me-1"></i> Eliminar
      </button>
     </div>
    </div>
   `;

   lista.appendChild(col);

   // --- Eventos ---
   
   // 1. Cambiar cantidad
   const inputCantidad = document.getElementById(`cantidad-${index}`);
   inputCantidad.addEventListener('change', () => {
    let cant = parseInt(inputCantidad.value);
    if(isNaN(cant) || cant < 1) cant = 1; // Asegura que sea al menos 1
      
    carrito[index].cantidad = cant; // Actualiza el objeto en el array
    localStorage.setItem('carrito', JSON.stringify(carrito));
    
    // Actualizar Subtotal y Total
    document.getElementById(`subtotal-${index}`).textContent = (precio * cant).toFixed(2);
    actualizarTotal();
   });

   // 2. Eliminar producto
   col.querySelector('.btn-eliminar').addEventListener('click', () => {
    carrito.splice(index, 1);
    localStorage.setItem('carrito', JSON.stringify(carrito));
    renderizarCarrito(); // Renderiza de nuevo todo el carrito
    // No es necesario llamar a actualizarTotal() aqu칤, renderizarCarrito lo hace
   });
  });
  
  // Despu칠s de renderizar todos los items, actualiza el total
  actualizarTotal();
 };

 // --- Evento Vaciar Carrito ---
 document.getElementById('vaciar-carrito').addEventListener('click', () => {
  if(confirm('쮼st치 seguro que desea vaciar su carrito? Esta acci칩n no se puede deshacer.')){
   carrito = [];
   localStorage.setItem('carrito', JSON.stringify(carrito));
   renderizarCarrito();
   // Se elimin칩 el 'alert' por ser molesto y se conf칤a en la funci칩n 'renderizarCarrito'
  }
 });

 // --- Inicializaci칩n ---
 renderizarCarrito();
});
</script>
{% endblock %}