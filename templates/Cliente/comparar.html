{% extends "common/base.html" %}

{% block navbar %}
{% include "common/partials/navbar_cliente.html" %}
{% include "common/partials/navbar_secundario2.html" %}
{% endblock %}

{% block content %}
<div class="container mt-5">
  <h2 class="mb-4 text-center text-success">Comparar Productos</h2>

  <div class="row" id="productos-container">
    {% for producto in productos %}
    <div class="col-md-4 mb-4">
      <div class="card h-100 shadow-sm text-center" data-id="{{ producto.ID_Producto }}">
        <img src="{{ url_for('static', filename=producto.ImagenPrincipal or 'img/catalogo.png') }}" 
             class="card-img-top" style="height:200px; object-fit:cover;">
        <div class="card-body">
          <h5 class="card-title">{{ producto.NombreProducto }}</h5>
          <p class="card-text precio">${{ '%.2f'|format(producto.PrecioUnidad) }}</p>
          <button class="btn btn-outline-info btn-select-compare" data-id="{{ producto.ID_Producto }}">
            Seleccionar
          </button>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <div id="comparativa" class="mt-5" style="display:none;">
    <h3 class="text-center mb-4">Cuadro Comparativo</h3>
    <div class="row" id="cuadro-comparativo"></div>
  </div>
</div>

<a href="#" id="btn-comparar" class="btn btn-warning shadow-lg position-fixed rounded-pill px-4 py-2"
   style="bottom: 30px; right: 30px; z-index: 1050; display:none;">
   Comparar Productos
</a>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {

  let comparar = [];
  const btnComparar = document.getElementById('btn-comparar');
  const cuadro = document.getElementById('cuadro-comparativo');
  const contenedorComparativa = document.getElementById('comparativa');

  function actualizarBotones() {
    document.querySelectorAll('.btn-select-compare').forEach(btn => {
      const id = btn.getAttribute('data-id');
      if(comparar.includes(id)) {
        btn.classList.add('active');
        btn.classList.remove('btn-outline-info');
        btn.classList.add('btn-info', 'text-white');
        btn.textContent = 'Seleccionado';
      } else {
        btn.classList.remove('active');
        btn.classList.remove('btn-info', 'text-white');
        btn.classList.add('btn-outline-info');
        btn.textContent = 'Seleccionar';
      }
    });
    btnComparar.style.display = comparar.length > 0 ? 'inline-block' : 'none';
  }

  document.querySelectorAll('.btn-select-compare').forEach(btn => {
    btn.addEventListener('click', function() {
      const id = this.getAttribute('data-id');
      if(comparar.includes(id)){
        comparar = comparar.filter(x => x !== id);
      } else {
        if(comparar.length >= 2){
          alert("Solo puedes seleccionar 2 productos para comparar.");
          return;
        }
        comparar.push(id);
      }
      actualizarBotones();
    });
  });

  btnComparar.addEventListener('click', function(e){
    e.preventDefault();
    if(comparar.length < 2){
      alert("Selecciona 2 productos para comparar.");
      return;
    }

    // Limpiar cuadro comparativo
    cuadro.innerHTML = '';
    comparar.forEach(id => {
      const prodCard = document.querySelector(`.card[data-id='${id}']`);
      if(!prodCard) return;

      const img = prodCard.querySelector('img').src;
      const nombre = prodCard.querySelector('.card-title').textContent;
      const precio = prodCard.querySelector('.precio').textContent;

      const div = document.createElement('div');
      div.className = 'col-md-6 mb-3';
      div.innerHTML = `
        <div class="card h-100 shadow-sm text-center">
          <img src="${img}" class="card-img-top" style="height:200px; object-fit:cover;">
          <div class="card-body">
            <h5 class="card-title">${nombre}</h5>
            <p class="card-text">${precio}</p>
          </div>
        </div>
      `;
      cuadro.appendChild(div);
    });

    contenedorComparativa.style.display = 'block';
    window.scrollTo({ top: contenedorComparativa.offsetTop - 20, behavior: 'smooth' });
  });

});
</script>
{% endblock %}
