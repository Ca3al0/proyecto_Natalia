{% extends "common/base.html" %}

{% block navbar %}
  {% include "common/partials/navbar_cliente.html" %}
  {% include "common/partials/navbar_secundario2.html" %}
{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/notificaciones.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/flash.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/detalles.css') }}">

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category }} flash-small d-flex align-items-center" role="alert">
        {% if category == 'success' %}<i class="bi bi-check-circle-fill me-2"></i>
        {% elif category == 'danger' %}<i class="bi bi-x-circle-fill me-2"></i>
        {% elif category == 'warning' %}<i class="bi bi-exclamation-triangle-fill me-2"></i>
        {% elif category == 'info' %}<i class="bi bi-info-circle-fill me-2"></i>{% endif %}
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<!-- Detalle del producto -->
<div class="container mt-5">
  <div class="row">
    <!-- Imagen -->
    <div class="col-md-6">
      <img src="{{ url_for('static', filename=producto.ImagenPrincipal) if producto.ImagenPrincipal else url_for('static', filename='img/salacarrusel.png') }}" 
           alt="Imagen de {{ producto.NombreProducto }}" 
           class="img-fluid rounded shadow-sm mb-4" 
           style="max-height: 450px; object-fit: contain; width: 100%;">
    </div>

    <!-- Detalles -->
    <div class="col-md-6">
      <h2 class="fw-bold">{{ producto.NombreProducto }}</h2>
      <h4 class="text-success">${{ '%.2f'|format(producto.PrecioUnidad) }}</h4>

      <ul class="list-unstyled mt-3 mb-4">
        <li><strong>Material:</strong> {{ producto.Material or 'No especificado' }}</li>
        <li><strong>Color:</strong> {{ producto.Color or 'No especificado' }}</li>
        {% if producto.Stock is not none %}
          <li><strong>Stock disponible:</strong> {{ producto.Stock }}</li>
        {% endif %}
      </ul>

      <h5>Descripción</h5>
      <p>{{ producto.Descripcion or 'No hay descripción disponible.' }}</p>

      <!-- Selección de dirección -->
      <div class="mt-3">
        <label for="direccion" class="form-label fw-bold">Selecciona dirección de entrega:</label>
        <select id="direccion" class="form-select">
          <option value="">-- Selecciona una dirección --</option>
        </select>
      </div>

      <!-- Método de pago -->
      <div class="mt-3">
        <label for="metodo_pago" class="form-label fw-bold">Método de pago:</label>
        <select id="metodo_pago" class="form-select">
          <option value="Efectivo">Efectivo</option>
          <option value="Tarjeta">Tarjeta</option>
          <option value="Transferencia">Transferencia</option>
        </select>
      </div>

      <button id="btn-comprar" 
        class="btn btn-success mt-4"
        data-id="{{ producto.ID_Producto }}">
        <i class="bi bi-cart-plus me-2"></i> Comprar
      </button>

      <a href="{{ url_for('catalogo') }}" class="btn btn-secondary mt-3">
        <i class="bi bi-arrow-left-circle me-2"></i> Volver al catálogo
      </a>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', async () => {

    const btnComprar = document.getElementById('btn-comprar');
    const selectDireccion = document.getElementById('direccion');
    const selectMetodoPago = document.getElementById('metodo_pago');

    // Mostrar mensajes flotantes
    const mostrarMensaje = (texto, tipo='success') => {
        const alert = document.createElement('div');
        alert.className = `alert alert-${tipo} position-fixed top-0 end-0 m-4 shadow`;
        alert.style.zIndex = 2000;
        alert.innerHTML = `<i class="bi bi-check-circle-fill me-2"></i>${texto}`;
        document.body.appendChild(alert);
        setTimeout(() => alert.remove(), 3000);
    };

    // Cargar direcciones del usuario
    try {
        const res = await fetch('/cliente/api/direcciones');
        const data = await res.json();
        data.forEach(d => {
            selectDireccion.innerHTML += `<option value="${d.id}">
                ${d.destinatario} - ${d.direccion}, ${d.barrio}, ${d.ciudad}, ${d.departamento}, ${d.pais}
            </option>`;
        });
    } catch(err){
        console.error("Error al cargar direcciones:", err);
    }

    // Evento comprar
    btnComprar.addEventListener('click', async () => {
        const productoID = btnComprar.dataset.id;
        const direccionID = selectDireccion.value;
        const metodoPago = selectMetodoPago.value;

        if(!direccionID){
            mostrarMensaje("Debes seleccionar una dirección de entrega ❌", "danger");
            return;
        }

        try {
            const res = await fetch('/cliente/api/comprar', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({
                    ID_Producto: productoID,
                    ID_Direccion: direccionID,
                    MetodoPago: metodoPago
                })
            });
            const data = await res.json();
            if(res.ok){
                mostrarMensaje('Compra registrada correctamente ✅', 'success');
                setTimeout(()=> window.location.href='/cliente/pedidos', 1500);
            } else {
                mostrarMensaje(data.mensaje || 'Error al registrar la compra ❌', 'danger');
            }
        } catch(err){
            console.error(err);
            mostrarMensaje('Error en la conexión ❌', 'danger');
        }
    });

});
</script>
{% endblock %}
