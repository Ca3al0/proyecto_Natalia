{% extends "common/base.html" %}

{% block content %}
<div class="container mt-5">
    <h1 class="text-primary mb-5"><i class="bi bi-credit-card-2-back me-2"></i> Finalizar Compra (Checkout)</h1>
    
    <div id="flash-message-container" class="mb-4">
        </div>

    <div class="row">
        
        <div class="col-md-8">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0"><i class="bi bi-geo-alt-fill me-2"></i> Direcci√≥n de Env√≠o</h4>
                </div>
                <div class="card-body">
                    <form id="checkout-form">
                        <div class="mb-3">
                            <label for="nombre" class="form-label">Nombre Completo</label>
                            <input type="text" class="form-control" id="nombre" required value="Natalia G√≥mez">
                        </div>
                        
                        <div class="mb-3">
                            <label for="select-direccion" class="form-label">Seleccionar Direcci√≥n Existente</label>
                            <select class="form-select" id="select-direccion" required>
                                <option value="">Selecciona una direcci√≥n...</option>
                                </select>
                        </div>
                        <h4 class="mt-4 mb-3"><i class="bi bi-cash-stack me-2"></i> M√©todo de Pago</h4>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="pago" id="credito" value="credito" checked>
                                <label class="form-check-label" for="credito">Tarjeta de Cr√©dito / D√©bito</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="pago" id="nequi" value="nequi">
                                <label class="form-check-label" for="nequi">Nequi</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="pago" id="daviplata" value="daviplata">
                                <label class="form-check-label" for="daviplata">Daviplata</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="pago" id="efectivo" value="efectivo">
                                <label class="form-check-label" for="efectivo">Efectivo contra Entrega</label>
                            </div>
                        </div>

                        <div id="datos-tarjeta" class="card p-3 bg-light mt-3 border">
                            <h5>Datos de la Tarjeta</h5>
                            <div class="mb-3">
                                <label for="numero-tarjeta" class="form-label">N√∫mero de Tarjeta</label>
                                <input type="text" class="form-control" id="numero-tarjeta" required pattern="\d{16}" title="Debe contener 16 d√≠gitos" placeholder="Ej: 1111222233334444">
                            </div>
                            <div class="row">
                                <div class="col-6 mb-3">
                                    <label for="expiracion" class="form-label">Fecha Exp. (MM/AA)</label>
                                    <input type="text" class="form-control" id="expiracion" required pattern="(0[1-9]|1[0-2])\/\d{2}" placeholder="MM/AA">
                                </div>
                                <div class="col-6 mb-3">
                                    <label for="cvv" class="form-label">CVV</label>
                                    <input type="text" class="form-control" id="cvv" required pattern="\d{3,4}" placeholder="3 o 4 d√≠gitos">
                                </div>
                            </div>
                        </div>

                        <div id="datos-digitales" class="card p-3 bg-light mt-3 border" style="display: none;">
                            <h5>Datos de Pago Digital</h5>
                            <p class="text-muted small mb-2">Ingresa el n√∫mero de celular (10 d√≠gitos) asociado a la cuenta de Nequi o Daviplata.</p>
                            <div class="mb-3">
                                <label for="numero-celular" class="form-label">N√∫mero de Celular</label>
                                <input type="tel" class="form-control" id="numero-celular" required pattern="\d{10}" title="Debe ser un n√∫mero de 10 d√≠gitos" placeholder="Ej: 3001234567">
                            </div>
                        </div>

                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card shadow-lg sticky-top" style="top: 20px;">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0"><i class="bi bi-receipt me-2"></i> Resumen de la Orden</h4>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush mb-3" id="resumen-productos">
                        </ul>
                    <ul class="list-group list-group-flush border-top pt-2">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            **Subtotal:**
                            <span class="fw-bold" id="checkout-subtotal">$0.00</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            **Costo de Env√≠o:**
                            <span class="fw-bold text-danger" id="checkout-envio">$5.00</span> 
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center bg-light">
                            <h5 class="mb-0 text-success">**Total a Pagar:**</h5>
                            <h5 class="mb-0 text-success" id="checkout-total">$0.00</h5>
                        </li>
                    </ul>
                </div>
            </div>
            
            <button id="btn-pagar" class="btn btn-success btn-lg w-100 mt-3 shadow-lg">
                <i class="bi bi-lock-fill me-2"></i> Confirmar y Pagar
            </button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    let carrito = JSON.parse(localStorage.getItem('carrito') || '[]');
    const costoEnvio = 5.00; 
    let totalFinal = 0; 
    
    // --- SIMULACI√ìN DE DATOS DE DIRECCI√ìN (Lo que vendr√≠a de tu base de datos) ---
    const direccionesGuardadas = [
        { id: 1, alias: 'Casa Principal', direccion: 'Calle 10 # 5-20, Apto 301, Bogot√°' },
        { id: 2, alias: 'Oficina (Trabajo)', direccion: 'Av. Cra 7 # 75-10, Piso 12, Medell√≠n' },
        { id: 3, alias: 'Casa de Mam√°', direccion: 'Carrera 40 # 5A-15, Cali' },
    ];

    // --- UTILERIAS ---
    const mostrarMensaje = (texto, tipo, duration = 5000) => {
        const container = document.getElementById('flash-message-container');
        container.innerHTML = ''; 
        const alert = document.createElement('div');
        let iconClass;

        if (tipo === 'success') iconClass = 'bi-check-circle-fill';
        else if (tipo === 'danger') iconClass = 'bi-x-octagon-fill';
        else if (tipo === 'warning') iconClass = 'bi-exclamation-triangle-fill';
        else iconClass = 'bi-info-circle-fill';

        alert.className = `alert alert-${tipo} d-flex align-items-center`;
        alert.setAttribute('role', 'alert');
        alert.innerHTML = `<i class="bi ${iconClass} me-2 fs-4"></i><div>${texto}</div>`;
        
        container.appendChild(alert);
        setTimeout(() => alert.remove(), duration);
    };

    // --- L√ìGICA DE C√ÅLCULO Y RENDERIZADO ---
    const actualizarTotal = (subtotal) => {
        const totalPagar = subtotal + costoEnvio;
        document.getElementById('checkout-subtotal').textContent = `$${subtotal.toFixed(2)}`;
        document.getElementById('checkout-envio').textContent = `$${costoEnvio.toFixed(2)}`;
        document.getElementById('checkout-total').textContent = `$${totalPagar.toFixed(2)}`;
        return totalPagar;
    };

    const renderizarResumen = () => {
        const resumenProductos = document.getElementById('resumen-productos');
        resumenProductos.innerHTML = '';
        let subtotal = 0;

        if (carrito.length === 0) {
            document.querySelector('.container').innerHTML = `
                <div class="alert alert-warning text-center mt-5" role="alert">
                    <h4 class="alert-heading">Tu carrito est√° vac√≠o</h4>
                    <p>No hay productos para finalizar la compra.</p>
                    <hr>
                    <a href="{{ url_for('catalogo') }}" class="btn btn-warning">Volver al Cat√°logo</a>
                </div>
            `;
            return 0; 
        }

        carrito.forEach(item => {
            const precio = parseFloat(item.precio || 0); 
            const cantidad = parseInt(item.cantidad || 1); 
            const subtotalItem = precio * cantidad;
            subtotal += subtotalItem;

            const listItem = document.createElement('li');
            listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
            listItem.innerHTML = `
                ${item.nombre} x ${cantidad}
                <span class="text-secondary">$${subtotalItem.toFixed(2)}</span>
            `;
            resumenProductos.appendChild(listItem);
        });

        totalFinal = actualizarTotal(subtotal);
        return subtotal;
    };
    
    // --- L√ìGICA DE DIRECCI√ìN ---
    const cargarDirecciones = () => {
        const select = document.getElementById('select-direccion');
        direccionesGuardadas.forEach(dir => {
            const option = document.createElement('option');
            option.value = dir.direccion;
            option.textContent = `${dir.alias}: ${dir.direccion.substring(0, 30)}...`;
            select.appendChild(option);
        });
    };

    // --- SIMULACI√ìN DE PAGO (AJUSTADA) ---
    const simularPago = (metodo, total) => {
        return new Promise((resolve) => {
            const delay = 1000; 
            
            setTimeout(() => {
                if (metodo === 'credito') {
                    const numTarjeta = document.getElementById('numero-tarjeta').value;
                    if (numTarjeta.length !== 16 || !/^\d+$/.test(numTarjeta)) {
                         resolve({ success: false, message: "Error: El n√∫mero de tarjeta debe ser de 16 d√≠gitos.", redirect: false });
                         return;
                    }
                    if (numTarjeta.slice(-4) === '0000') {
                        resolve({ success: false, message: `Transacci√≥n **FALLIDA** (Tarjeta rechazada). Intenta con otra tarjeta.`, redirect: false });
                    } else {
                        resolve({ success: true, message: `‚úÖ ¬°Pago de $${total.toFixed(2)} **APROBADO**! Tu pedido ha sido confirmado.`, redirect: true, delay: 1500 });
                    }

                } else if (metodo === 'nequi' || metodo === 'daviplata') {
                    const celular = document.getElementById('numero-celular').value;
                    if (celular.length !== 10 || !/^\d+$/.test(celular)) {
                         resolve({ success: false, message: `Error en ${metodo}: El n√∫mero de celular debe ser de 10 d√≠gitos.`, redirect: false });
                         return;
                    }

                    if (celular.slice(-4) === '1234') {
                        resolve({ success: false, message: `Transacci√≥n con **${metodo.toUpperCase()}** FALLIDA. Saldo insuficiente.`, redirect: false });
                    } else {
                        // Pago instant√°neo (simulando que el usuario aprob√≥ en la app)
                        resolve({ success: true, message: `‚úÖ Pago de $${total.toFixed(2)} con **${metodo.toUpperCase()}** **APROBADO** de inmediato.`, redirect: true, delay: 1500 });
                    }

                } else if (metodo === 'efectivo') {
                    // Pago en efectivo solo confirma la orden, no el pago
                    resolve({ success: true, message: `üõçÔ∏è Orden Confirmada. Prepara $${total.toFixed(2)} para el pago en **Efectivo** al recibir.`, redirect: true, delay: 2500 });
                } else {
                    resolve({ success: false, message: "M√©todo de pago no reconocido.", redirect: false });
                }
            }, delay); 
        });
    };

    // --- EVENT LISTENERS ---

    // 1. Mostrar/Ocultar datos seg√∫n el m√©todo de pago
    const radioPagos = document.querySelectorAll('input[name="pago"]');
    const datosTarjetaDiv = document.getElementById('datos-tarjeta');
    const datosDigitalesDiv = document.getElementById('datos-digitales');
    const numeroCelularInput = document.getElementById('numero-celular');
    const tarjetaInputs = datosTarjetaDiv.querySelectorAll('input');

    const togglePaymentInputs = () => {
        const metodoSeleccionado = document.querySelector('input[name="pago"]:checked').value;
        
        const isCredito = metodoSeleccionado === 'credito';
        const isDigital = metodoSeleccionado === 'nequi' || metodoSeleccionado === 'daviplata';

        datosTarjetaDiv.style.display = isCredito ? 'block' : 'none';
        datosDigitalesDiv.style.display = isDigital ? 'block' : 'none';

        // Requerir campos din√°micamente
        tarjetaInputs.forEach(input => input.required = isCredito);
        numeroCelularInput.required = isDigital;
    };

    radioPagos.forEach(radio => {
        radio.addEventListener('change', togglePaymentInputs);
    });

    // 2. Bot√≥n de Pago
    document.getElementById('btn-pagar').addEventListener('click', async (e) => {
        e.preventDefault();

        const form = document.getElementById('checkout-form');
        // Validar campos de env√≠o/nombre y los campos de pago requeridos
        if (!form.reportValidity()) {
            return; 
        }

        const btnPagar = e.currentTarget;
        const metodoSeleccionado = document.querySelector('input[name="pago"]:checked').value;
        
        btnPagar.disabled = true;
        btnPagar.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Procesando...';

        try {
            const resultado = await simularPago(metodoSeleccionado, totalFinal);

            if (resultado.success) {
                mostrarMensaje(resultado.message, 'success', resultado.redirect ? resultado.delay + 1000 : 5000); 

                if (resultado.redirect) {
                    // Pago o confirmaci√≥n inmediata, vaciar carrito y redirigir
                    localStorage.setItem('carrito', '[]'); 
                    setTimeout(() => {
                        window.location.href = "{{ url_for('catalogo') }}"; 
                    }, resultado.delay || 1500); 
                } else {
                    // Pago manual (ej. Transferencia, aunque lo quitamos, se deja por si acaso), re-habilitar bot√≥n
                    btnPagar.disabled = false;
                    btnPagar.innerHTML = '<i class="bi bi-lock-fill me-2"></i> Confirmar y Pagar';
                }

            } else {
                mostrarMensaje(resultado.message, 'danger');
                btnPagar.disabled = false;
                btnPagar.innerHTML = '<i class="bi bi-lock-fill me-2"></i> Confirmar y Pagar';
            }
        } catch (error) {
            mostrarMensaje(`Ocurri√≥ un error inesperado: ${error.message}`, 'danger');
            btnPagar.disabled = false;
            btnPagar.innerHTML = '<i class="bi bi-lock-fill me-2"></i> Confirmar y Pagar';
        }
    });

    // --- INICIALIZACI√ìN ---
    renderizarResumen(); 
    cargarDirecciones();
    togglePaymentInputs();
});
</script>
{% endblock %}