{% extends "common/base.html" %}

{% block navbar %}
  {% include "common/partials/navbar_transpoinsta.html" %}
{% endblock %}

{% block content %}

<link rel="stylesheet" href="{{ url_for('static', filename='css/calendario.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/flash.css') }}">

<div id="calendar"></div>

<!-- Modal Evento -->
<div id="eventModal" class="modal">
    <div class="modal-content">
        <div class="modal-header" id="modalTitle"></div>
        <div class="modal-body" id="modalBody"></div>
        <div class="modal-footer">
            <button onclick="closeModal()">Cerrar</button>
        </div>
    </div>
</div>

<!-- Modal Registro Fotográfico -->
<div id="registroFotograficoModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">Registro Fotográfico</div>
        <div class="modal-body">
            <form id="registroFotograficoForm" enctype="multipart/form-data">
                <!-- ESTE INPUT ES IMPORTANTE -->
                <input type="hidden" name="pedido_id" id="pedido_id" value="">

                <div style="margin-bottom:15px; border-bottom:1px solid #ccc; padding-bottom:10px;">
                    <label><strong>Fotos Antes:</strong></label><br>
                    <input type="file" name="fotos_antes" multiple accept="image/*" capture="environment"><br><br>
                    <label><strong>Descripción Antes:</strong></label><br>
                    <textarea name="desc_antes" rows="3" style="width:100%;border-radius:6px;border:1px solid #ccc;padding:5px;"></textarea>
                </div>

                <div style="margin-bottom:15px; border-bottom:1px solid #ccc; padding-bottom:10px;">
                    <label><strong>Fotos Después:</strong></label><br>
                    <input type="file" name="fotos_despues" multiple accept="image/*" capture="environment"><br><br>
                    <label><strong>Descripción Después:</strong></label><br>
                    <textarea name="desc_despues" rows="3" style="width:100%;border-radius:6px;border:1px solid #ccc;padding:5px;"></textarea>
                </div>

                <div class="modal-footer">
                    <button type="button" onclick="cerrarRegistro()">Cancelar</button>
                    <button type="submit">Guardar Registro</button>
                </div>
            </form>

            <!-- Preview del registro -->
            <div id="registroPreview" style="display:none; margin-top:20px;">
                <h4>Registro Guardado</h4>
                <div id="previewAntes">
                    <h5>Antes</h5>
                    <div id="imagenesAntes"></div>
                    <p id="descripcionAntes"></p>
                </div>
                <div id="previewDespues">
                    <h5>Después</h5>
                    <div id="imagenesDespues"></div>
                    <p id="descripcionDespues"></p>
                </div>
                <div class="modal-footer">
                    <button onclick="cerrarRegistro()">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- FullCalendar -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales-all.min.js"></script>

<script>
const modal = document.getElementById("eventModal");
const modalTitle = document.getElementById("modalTitle");
const modalBody = document.getElementById("modalBody");
const registroModal = document.getElementById("registroFotograficoModal");

function openModal(title, body){
    modalTitle.textContent = title;
    modalBody.innerHTML = body;
    modal.style.display = "block";
}

function closeModal(){
    modal.style.display = "none";
}

function abrirRegistro(pedidoId){
    registroModal.style.display = 'block';
    document.getElementById('registroFotograficoForm').reset();
    document.getElementById('registroPreview').style.display = 'none';
    document.getElementById('registroFotograficoForm').style.display = 'block';
    document.getElementById('pedido_id').value = pedidoId;
}

function cerrarRegistro(){
    registroModal.style.display = 'none';
}

window.onclick = function(event){
    if(event.target == modal) closeModal();
    if(event.target == registroModal) cerrarRegistro();
}

// FullCalendar
document.addEventListener('DOMContentLoaded', function(){
    const calendarEl = document.getElementById('calendar');
    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView:'dayGridMonth',
        locale:'es',
        headerToolbar:{left:'prev,next today', center:'title', right:'dayGridMonth,timeGridWeek,timeGridDay'},
        events:{
            url:'/transportista/api/calendario',
            failure:function(){ openModal('Error','No se pudieron cargar los eventos'); }
        },
        eventClick:function(info){
            const tipo = (info.event.extendedProps.tipo || 'Evento').toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
            const usuario = info.event.extendedProps.usuario || 'Desconocido';
            const location = info.event.extendedProps.location || 'Ubicación no especificada';
            const title = info.event.title || 'Sin título';
            const idEvento = info.event.id || '';

            let body = `<p><strong>Tipo:</strong> ${tipo}</p>
                        <p><strong>Evento:</strong> ${title}</p>
                        <p><strong>Cliente:</strong> ${usuario}</p>
                        <p><strong>Ubicación:</strong> ${location}</p>`;

            // Botón para abrir Registro Fotográfico en pedidos o instalaciones
            if(tipo === 'instalacion' || tipo === 'pedido'){
                body += `<div style="margin-top:15px; text-align:center;">
                            <button class="modal-footer-btn" onclick="abrirRegistro('${idEvento}')">Registro Fotográfico</button>
                         </div>`;
            }

            openModal(title, body);
        },
        eventDidMount:function(info){
            info.el.style.cursor = 'pointer';
        }
    });
    calendar.render();
});

// Guardar registro vía AJAX
document.getElementById('registroFotograficoForm').addEventListener('submit', async function(e){
    e.preventDefault();
    const formData = new FormData(this);

    try {
        const response = await fetch('{{ url_for("transportista.guardar_registro") }}', {
            method:'POST',
            body: formData
        });
        const result = await response.json();

        if(result.status === 'success'){
            alert('Registro guardado correctamente');
            abrirRegistro(document.getElementById('pedido_id').value); // recarga preview
        } else {
            alert('Error al guardar: '+(result.message||'Error desconocido'));
        }
    } catch(err){
        alert('Error de red: '+err.message);
    }
});

</script>

{% endblock %}
